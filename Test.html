<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Auswertung</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .title-box {
            background: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .title-box h1 {
            margin: 0;
            font-size: 28px;
        }

        .upload-box {
            background: white;
            padding: 20px;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .upload-btn {
            background-color: #04AA6D;
            color: white;
            padding: 16px 32px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .upload-btn:hover {
            background-color: #3e8e41;
        }

        #fileInput {
            display: none;
        }

        .matrix-container {
            background: white;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid black;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background-color: #f5f5f5;
        }

        tr:hover {
            background-color: #e9ecef;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .error-message {
            background: #ff4444;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }

        .file-info {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
        .dropdown {
            position: relative;
            top: 0;
            left: 0;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: fixed;
            background-color: #f1f1f1;
            min-width: 160px;
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
            z-index: 2;
        }

        .dropdown-content button {
            color: black;
            width: 100%;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        /* Change color of dropdown links on hover */
        .dropdown-content button:hover {background-color: #ddd;}

        /* Show the dropdown menu on hover */
        .dropdown:hover .dropdown-content {display: block;}

        /* Change the background color of the dropdown button when the dropdown content is shown */
        .dropdown:hover .dropbtn {background-color: #3e8e41;}
    </style>
</head>
<body>
<div class="container">
    <div class="title-box">
        <h1>Auswertung</h1>
    </div>

    <div class="upload-box">
        <input type="file" id="fileInput" accept=".json" multiple>
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
            JSON Dateien hochladen
        </button>

        <div class="dropdown">
            <button class="upload-btn">Exportieren</button>
            <div class="dropdown-content">
                <button onclick="exportCsv()">CSV</button>
                <button onclick="exportPdf()">PDF</button>
            </div>
        </div>

        <div class="file-info" id="fileInfo"></div>
        <div class="error-message" id="errorMessage"></div>
    </div>

    <div class="matrix-container">
        <div id="tableContainer">
            <div class="no-data">Bitte laden Sie JSON-Dateien, um die Auswertung anzuzeigen.</div>
        </div>
    </div>
</div>

<script>
    let allData = [];
    let fieldTitles = [];

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const files = e.target.files;
        if (files.length === 0) return;

        allData = [];
        fieldTitles = [];

        const fileInfo = document.getElementById('fileInfo');
        fileInfo.textContent = `${files.length} Datei(en) ausgewÃ¤hlt`;

        let filesProcessed = 0;

        Array.from(files).forEach(file => {
            const reader = new FileReader();

            reader.onload = function(event) {
                try {
                    const jsonData = JSON.parse(event.target.result);
                    processJsonData(jsonData, file.name);
                    filesProcessed++;

                    if (filesProcessed === files.length) {
                        generateTable();
                    }
                } catch (error) {
                    showError(`Fehler beim Laden von ${file.name}: ${error.message}`);
                }
            };

            reader.onerror = function() {
                showError(`Fehler beim Lesen von ${file.name}`);
            };

            reader.readAsText(file);
        });
    });

    function processJsonData(data, fileName) {
        const rowData = {
            fileName: fileName,
            values: {}
        };

        if (data && Array.isArray(data)) {
            data.forEach(field => {
                const title = field.title || 'Unbekannt';

                if (!fieldTitles.includes(title)) {
                    fieldTitles.push(title);
                }

                rowData.values[title] = field.value;
            });
        }

        allData.push(rowData);
    }

    function generateTable() {
        const tableContainer = document.getElementById('tableContainer');

        if (allData.length === 0 || fieldTitles.length === 0) {
            tableContainer.innerHTML = '<div class="no-data">Keine Daten gefunden.</div>';
            return;
        }

        let tableHTML = '<table><thead><tr>';
        tableHTML += '<th>Dateiname</th>';

        fieldTitles.forEach(title => {
            tableHTML += `<th>${escapeHtml(title)}</th>`;
        });

        tableHTML += '</tr></thead><tbody>';

        allData.forEach(row => {
            tableHTML += '<tr>';
            tableHTML += `<td>${escapeHtml(row.fileName)}</td>`;

            fieldTitles.forEach(title => {
                const value = row.values[title] || '-';
                tableHTML += `<td>${escapeHtml(String(value))}</td>`;
            });

            tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table>';
        tableContainer.innerHTML = tableHTML;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';

        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }
</script>
<script>
    function exportPdf(){
        let table = document.getElementById("tableContainer").innerHTML;
        let printWindow = window.open("", "", "height=500, width=500");
        printWindow.document.open();
        const htmlContent = '<html lang="De">\n'+
        '<head>\n'+
            '<title>Auswertung</title>\n'+
            '<style>\n'+
                'body { font-family: Arial, sans-serif; }\n'+
                'h1 { color: #333; }\n'+
                'th, td {\n'+
                'border: 1px solid black;\n'+
                'padding: 12px;\n'+
                'text-align: left;\n'+
            '}\n'+
            '</style>\n'+
        '</head>\n'+
        '<body>\n'+
        '<h1>Auswertung</h1>\n'+
        table +
        '</body>\n'+
        '</html>';

        printWindow.document.write(htmlContent)
        printWindow.document.close();
        printWindow.print();
    }

    function exportCsv() {
        let csv_data = [];
        let rows = document.getElementsByTagName("tr");
        for (let i = 0; i < rows.length; i++) {
            let cols = rows[i].querySelectorAll("td,th");

            let csvrow = [];
            for (let j = 0; j < cols.length; j++) {
                csvrow.push(cols[j].innerHTML);
            }

            csv_data.push(csvrow.join(","));
        }

        csv_data = csv_data.join("\n");

        downloadCsv(csv_data)

    }

    function downloadCsv(csv_data) {
        CSVFile = new Blob([csv_data], { type: "text/csv" });

        let temp_link = document.createElement('a');

        temp_link.download = `Auswertung.csv`;
        let url = window.URL.createObjectURL(CSVFile);
        temp_link.href = url;

        temp_link.style.display = "none";
        document.body.appendChild(temp_link);

        temp_link.click();
        document.body.removeChild(temp_link);
    }

</script>
</body>
</html>