<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>VelociDACSor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #form-builder {
            position: relative;
            margin: 0 auto;
            width: 50%;
            height: 100%;
            background: #f0f0f0;
        }

        .field {
            position: absolute;
            top: 50px;
            left: 50px;
            width: 100%;
            background: #ffffff;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        .field-header {
            cursor: move;
            background: #007bff;
            color: #fff;
            padding: 8px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 6px 6px 0 0;
        }

        .field-title {
            font-size: 14px;
            font-weight: bold;
            position: relative;
        }


        .field-required {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }

        .field-body {
            padding: 10px 0;
            position: relative;
        }

        .field-required-label {
            position: absolute;
            top: 0;
            right: 0;
            color: black;
            font-size: 12px;
            font-weight: bold;
        }

        .field-required-indicator {
            color: #ffeb3b;
            margin-left: 4px;
            font-size: 14px;
        }

        /* Konfiguration (Titel & Zusatzinfo) */
        .field-config {
            margin-bottom: 8px;
            padding: 6px;
            background: #f5f5f5;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 12px;
        }

        .field-config label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
        }

        .field-config input[type="text"],
        .field-config textarea {
            width: 100%;
            box-sizing: border-box;
            font-size: 12px;
            padding: 4px;
            border-radius: 3px;
            border: 1px solid #ccc;
            margin-bottom: 6px;
            resize: vertical;
        }

        .dropbtn {
            background-color: #04AA6D;
            color: white;
            padding: 16px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
        }

        .dropdown {
            position: relative;
            top: 0;
            left: 0;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: fixed;
            background-color: #f1f1f1;
            min-width: 160px;
            box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.2);
            z-index: 2;
        }

        .dropdown-content button {
            color: black;
            width: 100%;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        /* Change color of dropdown links on hover */
        .dropdown-content button:hover {
            background-color: #ddd;
        }

        /* Show the dropdown menu on hover */
        .dropdown:hover .dropdown-content {
            display: block;
        }

        /* Change the background color of the dropdown button when the dropdown content is shown */
        .dropdown:hover .dropbtn {
            background-color: #3e8e41;
        }

        .topmenu {
            height: 50px;
            width: 100%;
            position: sticky;
            top: 0;
            overflow-y: visible;
            z-index: 1;
        }

        .page {
            overflow-y: auto;
            position: absolute;
            top: 50px;
            bottom: 50px;
            width: 100%;
        }

        .spacer {
            bottom: 0;
            margin: 0 auto;
            position: absolute;
            height: 50px;
            width: 100%;
        }

        .btn {
            background-color: #04AA6D;
            color: white;
            padding: 16px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
        }

        .title {
            padding: 15px;
            font-size: 16px;
            border-radius: 4px;
        }

        .rightMenu {
            width: 25%;
            top: 0;
            right: 0;
            position: absolute;
            height: 50px;
            display: inline-block;
        }

        .disapear {
            display: none;
        }

        .preview {
            max-height: 50px;
            max-width: 50px;
            display: inline-block;
            position: relative;
        }
    </style>
</head>
<body>


<div class="topmenu">
    <div class="dropdown">
        <button class="dropbtn">Hinzufügen</button>
        <div class="dropdown-content">
            <button onclick="addTextField()">Text</button>
            <button onclick="addInfoField()">Info</button>
            <button onclick="addNumberField()">Zahlen</button>
            <button onclick="addDateField()">Datum</button>
            <button onclick="addPictureField()">Bild</button>
            <button onclick="addFileField()">Datei</button>
            <button onclick="addDropdownField()">Dropdown</button>
            <button onclick="addMultipleChoiceField()">Mehrfachauswahl</button>
        </div>
    </div>

    <div class="dropdown">
        <button class="dropbtn">Export</button>
        <div class="dropdown-content">
            <button id="saveBtn">Speichern</button>
            <button id="exportBtn">Exportieren</button>
        </div>
    </div>

    <label for="importFile" class="btn">Import</label>
    <input id="importFile" type="file" accept="*/*" class="disapear">

    <div class="rightMenu">
        <label>
            <input type="text" placeholder="Titel" id="title" class="title">
        </label>
        <label for="logo" class="btn">Logo wählen</label>
        <input type="file" accept="image/*" id="logo" class="disapear">

        <img src="#" alt="" id="preview" class="preview">

    </div>
</div>

<div class="spacer"></div>


<div class="page">
    <div id="form-builder"></div>
</div>

<script>

    document.getElementById("title").value = ""

    // ===== Oberklasse: BaseField =====
    class BaseField {
        constructor(options) {
            // Erhöhe Zähler bei jeder neuen Instanz
            this.instanceId = options.id || specs["vars"]["id-counter"]++;  // Speichere aktuelle Nummer in der Instanz

            this.type = options.type || "base";
            this.title = options.title || "";       // intern gespeichert
            this.infoText = options.infoText || "";
            this.required = !!options.required;
            this.x = options.x || 0;
            this.y = options.y || 0;

            this.createDOM();
            this.initDrag();
            this.initRequiredCheckbox();
            this.initConfigUI(); // Titel + Zusatzinfo editierbar

            insertField(this);
        }

        createDOM() {
            const container = document.getElementById("form-builder");

            this.el = document.createElement("div");
            this.el.className = "field"; //weißt eine CSS-Klasse für Styling zu
            this.el.style.left = this.x + "px"; //Position X
            this.el.style.top = this.y + "px"; //Position Y
            this.el.id = String(this.instanceId)

            // Header
            const header = document.createElement("div");
            header.className = "field-header";

            const titleSpan = document.createElement("span");
            titleSpan.className = "field-title";
            titleSpan.textContent = "Feld"; // Anzeige bleibt immer gleich
            if (this.infoText) {
                titleSpan.setAttribute("data-info", this.infoText);
            }
            this.titleEl = titleSpan;

            const btnUp = document.createElement("button");
            btnUp.className = "move-btn";
            btnUp.textContent = "^"
            const field = this.el;
            const parent = this
            btnUp.onclick = function () {
                container.insertBefore(field, field.previousElementSibling);
                if (field.previousElementSibling === null) {
                    moveField(field.id, 0);
                } else {
                    moveField(field.id, getFieldPos(field.previousElementSibling.id));
                }
                parent.repositionAllFields();
            };

            const btnDown = document.createElement("button");
            btnDown.className = "move-btn";
            btnDown.textContent = "v"
            btnDown.onclick = function () {
                container.insertBefore(field.nextElementSibling, field);
                if (field.nextElementSibling === null) {
                    moveField(field.id);
                } else {
                    moveField(field.nextElementSibling.id, getFieldPos(field.id));
                }
                parent.repositionAllFields();
            }

            const rightHeader = document.createElement("div");
            rightHeader.className = "field-required";

            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.checked = this.required;
            this.requiredCheckbox = cb;

            const cbLabel = document.createElement("span");
            cbLabel.textContent = "Pflicht"; //Text für Label

            const reqIndicator = document.createElement("span");
            reqIndicator.className = "field-required-indicator";
            reqIndicator.textContent = this.required ? "*" : "";
            this.requiredIndicator = reqIndicator;

            // Delete Button hinzufügen
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "×";
            deleteBtn.style.marginLeft = "10px";
            deleteBtn.style.padding = "2px 8px";
            deleteBtn.style.backgroundColor = "#ff4444";
            deleteBtn.style.color = "white";
            deleteBtn.style.border = "none";
            deleteBtn.style.borderRadius = "3px";
            deleteBtn.style.cursor = "pointer";
            deleteBtn.style.fontSize = "16px";
            deleteBtn.style.fontWeight = "bold";

            deleteBtn.addEventListener("click", () => {
                this.el.remove();
                // Repositioniere alle verbleibenden Felder nach dem Löschen
                setTimeout(() => {
                    const container = document.getElementById("form-builder");
                    const allFields = container.querySelectorAll(".field");
                    let currentY = 0;

                    allFields.forEach(field => {
                        field.style.left = "0px";
                        field.style.top = currentY + "px";
                        currentY += field.offsetHeight + 10;
                    });
                }, 0);
                removeField(this);
            });

            rightHeader.appendChild(btnUp);
            rightHeader.appendChild(btnDown);
            //Checkbox, Label & Sternchen werden in "rechten Teil" hinzugefügt
            rightHeader.appendChild(cb);
            rightHeader.appendChild(cbLabel);
            rightHeader.appendChild(reqIndicator);
            rightHeader.appendChild(deleteBtn);

            //Header wird um den "rechten Teil" (Label, Checkbox, Stern) ergänzt
            header.appendChild(titleSpan);
            header.appendChild(rightHeader);

            const body = document.createElement("div");
            body.className = "field-body";
            this.bodyEl = body;

            this.el.appendChild(header);
            this.el.appendChild(body);
            container.appendChild(this.el);
        }

        initRequiredCheckbox() {
            this.requiredCheckbox.addEventListener("change", () => {
                this.required = this.requiredCheckbox.checked;
                this.requiredIndicator.textContent = this.required ? "*" : "";
                updateFieldProperties(this.instanceId, {
                    "required": this.requiredCheckbox.checked,
                });
            });
        }

        // Titel + Zusatzinfo editierbar (intern gespeichert)
        initConfigUI() {
            const config = document.createElement("div");
            config.className = "field-config";

            // Titel (intern gespeichert, nicht sichtbar im Header)
            const titleLabel = document.createElement("label");
            titleLabel.textContent = "Titel";

            const titleInput = document.createElement("input");
            titleInput.type = "text";
            titleInput.value = this.title;

            titleInput.addEventListener("input", () => {
                this.title = titleInput.value;
                updateFieldProperties(this.instanceId, {
                    "title": titleInput.value,
                });
            });

            // Zusatzinfo (Tooltip)
            const infoLabel = document.createElement("label");
            infoLabel.textContent = "Zusatzinfo";

            const infoInput = document.createElement("textarea");
            infoInput.rows = 2;
            infoInput.value = this.infoText;

            infoInput.addEventListener("input", () => {
                this.infoText = infoInput.value;
                if (this.infoText.trim()) {
                    this.titleEl.setAttribute("data-info", this.infoText);
                } else {
                    this.titleEl.removeAttribute("data-info");
                }
                updateFieldProperties(this.instanceId, {
                    "infoText": infoInput.value,
                });
            });

            config.appendChild(titleLabel);
            config.appendChild(titleInput);
            config.appendChild(infoLabel);
            config.appendChild(infoInput);

            this.bodyEl.appendChild(config);
        }

        initDrag() {
            // Mache das Feld draggable
            this.el.draggable = true;

            // Drag & Drop für Reihenfolge
            this.el.addEventListener('dragstart', (e) => {
                this.el.classList.add('dragging');
                this.el.style.opacity = '0.5';
                e.dataTransfer.effectAllowed = 'move';
            });

            this.el.addEventListener('dragend', (e) => {
                this.el.classList.remove('dragging');
                this.el.style.opacity = '1';
                this.repositionAllFields();
            });

            this.el.addEventListener('dragover', (e) => {
                e.preventDefault();
                const container = document.getElementById("form-builder");
                const draggingItem = container.querySelector('.dragging');
                if (!draggingItem || draggingItem === this.el) return;

                const siblings = [...container.querySelectorAll('.field:not(.dragging)')];
                const nextSibling = siblings.find(sibling => {
                    const box = sibling.getBoundingClientRect();
                    const offset = e.clientY - box.top - box.height / 2;
                    return offset < 0;
                });

                if (nextSibling) {
                    container.insertBefore(draggingItem, nextSibling);
                    moveField(draggingItem.id, getFieldPos(nextSibling.id));
                } else {
                    container.appendChild(draggingItem);
                    moveField(draggingItem.id);
                }
            });

            this.el.addEventListener('dragenter', (e) => {
                e.preventDefault();
                if (!this.el.classList.contains('dragging')) {
                    this.el.style.borderTop = '3px solid #007bff';
                }
            });

            this.el.addEventListener('dragleave', (e) => {
                this.el.style.borderTop = '';
            });

            this.el.addEventListener('drop', (e) => {
                e.preventDefault();
                this.el.style.borderTop = '';
            });
        }

        repositionAllFields() {
            const container = document.getElementById("form-builder");
            const allFields = container.querySelectorAll(".field");
            let currentY = 0;

            allFields.forEach(field => {
                field.style.left = "0px";
                field.style.top = currentY + "px";
                currentY += field.offsetHeight + 10;
                updateFieldProperties(field.id, {"x": field.offsetLeft, "y": field.offsetTop});
            });
        }

        // Für spätere HTML-Erzeugung vorbereiten
        toConfigObject() {
            const rect = this.el.getBoundingClientRect();
            const parentRect = this.el.parentElement.getBoundingClientRect();
            return {
                id: this.instanceId,
                type: this.type,            //Typ des Felds
                title: this.title,         // gespeicherter individueller Titel
                infoText: this.infoText,   // gespeicherter Tooltip
                required: this.required,
                x: rect.left - parentRect.left,
                y: rect.top - parentRect.top
            };
        }

        getID() {
            return this.instanceId;
        }

        getFiles() {
            return [];
        }
    }

    // Hinweis: toConfigObject() liefert später alle wichtigen Daten für HTML-Generierung

    class Textfield extends BaseField {
        constructor(options) {
            super({...options, type: "text"});
            this.titleEl.textContent = "Textfeld"; //Header Anzeige wird gesetzt
            updateField(this);
        }
    }

    class DropDownfield extends BaseField {
        constructor(options) {
            super({...options, type: "dropdown"});
            this.options = options.options || [];
            this.createSelectInput();
            if (this.options.length != 0) {
                console.log(this.options)
                this.readdOptions();
            }
            this.titleEl.textContent = "Dropdown-Feld";
            updateField(this);
        }

        createSelectInput() {
            const wrapper = document.createElement("div");

            // Label für das Dropdown
            const label = document.createElement("label");
            label.textContent = "Optionen";
            label.style.display = "block";
            label.style.marginBottom = "4px";
            label.style.fontSize = "12px";

            // Container für Input und Button
            const inputContainer = document.createElement("div");
            inputContainer.style.display = "flex";
            inputContainer.style.marginBottom = "10px";
            inputContainer.style.gap = "5px";

            // Textfeld für neue Optionen
            const input = document.createElement("input");
            input.type = "text";
            input.style.flex = "1";
            input.placeholder = "Neue Option eingeben";

            // Hinzufügen Button
            const addButton = document.createElement("button");
            addButton.textContent = "Hinzufügen";
            addButton.style.padding = "4px 8px";

            // Styling für drag & drop hinzufügen
            const optionsContainer = document.createElement("div");
            optionsContainer.style.maxHeight = "150px";
            optionsContainer.style.overflowY = "auto";
            optionsContainer.style.padding = "4px";

            // Event Listener für das Hinzufügen
            addButton.addEventListener("click", () => {
                if (input.value.trim()) {
                    this.addOption(input.value.trim());
                    input.value = "";
                    this.repositionAllFields();
                }
            });

            // Enter-Taste auch zum Hinzufügen nutzen
            input.addEventListener("keypress", (e) => {
                if (e.key === "Enter" && input.value.trim()) {
                    this.addOption(input.value.trim());
                    input.value = "";
                    this.repositionAllFields();
                }
            });

            inputContainer.appendChild(input);
            inputContainer.appendChild(addButton);

            wrapper.appendChild(label);
            wrapper.appendChild(inputContainer);
            wrapper.appendChild(optionsContainer);

            this.optionsContainer = optionsContainer;
            this.bodyEl.appendChild(wrapper);
        }

        readdOptions() {
            this.options.forEach(input => {
                console.log(input)
                this.addOption(input.trim())
            })
        }

        addOption(text) {
            const optionDiv = document.createElement("div");
            optionDiv.style.display = "flex";
            optionDiv.style.justifyContent = "space-between";
            optionDiv.style.alignItems = "center";
            optionDiv.style.padding = "4px";
            optionDiv.style.marginBottom = "4px";
            optionDiv.style.backgroundColor = "#f5f5f5";
            optionDiv.style.borderRadius = "4px";
            optionDiv.style.cursor = "move"; // Cursor für Drag & Drop

            // Drag & Drop Attribute
            optionDiv.draggable = true;

            // Drag & Drop Event Listener
            optionDiv.addEventListener('dragstart', (e) => {
                e.target.classList.add('dragging');
                e.target.style.opacity = '0.5';
            });

            optionDiv.addEventListener('dragend', (e) => {
                e.target.classList.remove('dragging');
                e.target.style.opacity = '1';
                this.updateOptions();
            });

            optionDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                const draggingItem = this.optionsContainer.querySelector('.dragging');
                const siblings = [...this.optionsContainer.querySelectorAll('div:not(.dragging)')];
                const nextSibling = siblings.find(sibling => {
                    const box = sibling.getBoundingClientRect();
                    const offset = e.clientY - box.top - box.height / 2;
                    return offset < 0;
                });

                if (nextSibling) {
                    this.optionsContainer.insertBefore(draggingItem, nextSibling);
                } else {
                    this.optionsContainer.appendChild(draggingItem);
                }
            });

            // Highlight beim Draggen
            optionDiv.addEventListener('dragenter', (e) => {
                e.preventDefault();
                optionDiv.style.borderTop = '2px solid #007bff';
            });

            optionDiv.addEventListener('dragleave', (e) => {
                e.preventDefault();
                optionDiv.style.borderTop = 'none';
            });

            optionDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                optionDiv.style.borderTop = 'none';
            });

            const optionText = document.createElement("span");
            optionText.textContent = text;
            optionText.style.fontSize = "12px";
            optionText.style.pointerEvents = "none"; // Verhindert Störungen beim Drag & Drop

            const deleteButton = document.createElement("button");
            deleteButton.textContent = "×";
            deleteButton.style.padding = "2px 6px";
            deleteButton.style.backgroundColor = "#ff4444";
            deleteButton.style.color = "white";
            deleteButton.style.border = "none";
            deleteButton.style.borderRadius = "3px";
            deleteButton.style.cursor = "pointer";

            deleteButton.addEventListener("click", () => {
                optionDiv.remove();
                this.updateOptions();
            });

            optionDiv.appendChild(optionText);
            optionDiv.appendChild(deleteButton);
            this.optionsContainer.appendChild(optionDiv);

            this.updateOptions();
        }

        updateOptions() {
            // Aktualisiert das Array mit allen Optionen
            this.options = Array.from(this.optionsContainer.querySelectorAll("span"))
                .map(span => span.textContent);
            updateFieldProperties(this.instanceId, {options: this.options})
        }

        toConfigObject() {
            const baseConfig = super.toConfigObject();
            return {
                ...baseConfig,
                options: this.options
            };
        }
    }


    class DateField extends BaseField {

        constructor(options) {
            super({...options, type: "date"});
            this.titleEl.textContent = "Datum";
            updateField(this);
        }
    }


    // Darf später nicht bearbeitbar sein, ansonsten ists gleich wie das Textfeld
    // Ist frei ziehbar, sollte auch nicht sein
    class InfoField extends BaseField {
        value = null;

        constructor(options) {
            super({...options, type: "info", required: false});
            this.titleEl.textContent = "Infofeld";
            this.createInfoInput();
            if (options.value != null) {
                this.el.children[1].children[1].children[1].value = options.value
            }
            updateField(this);
        }

        createInfoInput() {
            const wrapper = document.createElement("div");

            // Label
            const label = document.createElement("label");
            label.textContent = "Info Feld";
            label.style.display = "block";
            label.style.marginBottom = "4px";
            label.style.fontSize = "12px";

            // Input
            const input = document.createElement("textarea");
            input.rows = 2;
            this.value = input.value
            input.style.width = "100%";
            input.style.boxSizing = "border-box";

            input.addEventListener("input", () => {
                updateFieldProperties(this.instanceId, {
                    "value": input.value,
                });
            });

            // Combine the ELEMENTS!!!!
            wrapper.appendChild(label);
            wrapper.appendChild(input);
            this.bodyEl.appendChild(wrapper);
        }

        toConfigObject() {
            const rect = this.el.getBoundingClientRect();
            const parentRect = this.el.parentElement.getBoundingClientRect();
            return {
                id: this.instanceId,
                type: this.type,
                title: this.title,         // gespeicherter individueller Titel
                infoText: this.infoText,   // gespeicherter Tooltip
                required: this.required,
                value: this.value,
                x: rect.left - parentRect.left,
                y: rect.top - parentRect.top
            };
        }
    }


    class PictureField extends BaseField {
        //speichern im Base64-Format
        picture64 = null

        //Konstruktor ruft Basisklasse auf und setzt Feldtyp fest
        constructor(options) {
            super({...options, type: "picture"});
            this.titleEl.textContent = "Bild";
            this.src = options.src || "";
            this.createPictureInput();
            updateField(this);
        }

        createPictureInput() {
            const wrapper = document.createElement("div");
            let upload = this.picture64; //Lokale Kopie des gespeicherten Base64-Strings

            // Label
            const label = document.createElement("label");
            label.textContent = "Bild Feld";
            label.style.display = "block";
            label.style.marginBottom = "4px";
            label.style.fontSize = "12px";

            //Bild-Preview-Element
            const img = document.createElement("img")
            img.src = "#"
            img.alt = "Preview"
            img.style.maxWidth = "100%"
            img.style.maxHeight = "200px"
            img.style.width = "auto"
            img.style.height = "auto"
            img.style.display = "none"
            img.style.marginTop = "8px"
            img.style.border = "1px solid #ccc"
            img.style.borderRadius = "4px"

            // Input
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*";

            //Upload wird als Base64 eingelesen, gespeichert und Preview aktualisiert
            const id = this;
            const instanceID = this.instanceId;
            input.onchange = function () {
                let file = this.files[0];
                let reader = new FileReader();

                reader.onload = function (event) {
                    let base64String = event.target.result;
                    if (base64String != null && base64String !== "") {
                        upload = base64String;
                        id.bodyEl.children[1].children[2].src = base64String
                        id.bodyEl.children[1].children[2].style.display = "block"
                        id.repositionAllFields();
                        updateFieldProperties(instanceID, {
                            "src": base64String,
                        });
                    }
                };
                reader.readAsDataURL(file);
            }
            input.style.width = "100%";
            input.style.boxSizing = "border-box";


            // Combine the ELEMENTS!!!!
            wrapper.appendChild(label);
            wrapper.appendChild(input);
            wrapper.appendChild(img)
            this.bodyEl.appendChild(wrapper);
            if (this.src != null && this.src !== "") {
                id.bodyEl.children[1].children[2].src = this.src;
                id.bodyEl.children[1].children[2].style.display = "block"
                id.repositionAllFields();
            }
        }

        createPicture() {
            const wrapper = document.createElement("div");
            if (this.src) {
                const img = document.createElement("img");
                img.src = this.src;
                img.alt = this.title;
                img.style.maxWidth = "100%";
                img.style.maxHeight = "400px";
                img.style.width = "auto";
                img.style.height = "auto";
                img.style.display = "block";
                img.style.marginTop = "8px";
                img.style.border = "1px solid #ccc";
                img.style.borderRadius = "4px";
                wrapper.appendChild(img);
            }
            this.bodyEl.appendChild(wrapper);
        }
    }


    class FileField extends BaseField {

        constructor(options) {
            super({...options, type: "file"});
            this.titleEl.textContent = "Datei";
        }
    }

    class NumberField extends BaseField {

        constructor(options) {
            super({...options, type: "number"});
            this.titleEl.textContent = "Zahlenfeld";
            updateField(this);
        }
    }


    class Radio_MultipleChoicefield extends BaseField {
        constructor(options) {
            super({...options, type: "radio_multiple"});
            this.options = options.options || [];

            this.allowMultiple = options.allowMultiple || false;
            this.createOptionsInput();
            if (this.options.length != 0) {
                this.readdOptions();
            }
            this.titleEl.textContent = "Radio-/Multiple-Choice-Feld";
            updateField(this);
        }

        createOptionsInput() {
            const wrapper = document.createElement("div");

            // Checkbox für Mehrfachauswahl
            const multipleChoiceContainer = document.createElement("div");
            multipleChoiceContainer.style.marginBottom = "10px";

            const multipleChoice = document.createElement("input");
            multipleChoice.type = "checkbox";
            multipleChoice.id = "multipleChoice_" + this.instanceId;
            multipleChoice.checked = this.allowMultiple;

            const multipleChoiceLabel = document.createElement("label");
            multipleChoiceLabel.htmlFor = "multipleChoice_" + this.instanceId;
            multipleChoiceLabel.textContent = "Mehrfachauswahl erlauben";
            multipleChoiceLabel.style.fontSize = "12px";
            multipleChoiceLabel.style.marginLeft = "5px";

            multipleChoice.addEventListener("change", () => {
                this.allowMultiple = multipleChoice.checked;
                this.updateOptionsPreview();
                updateFieldProperties(this.instanceId, {allowMultiple: this.allowMultiple})
            });

            multipleChoiceContainer.appendChild(multipleChoice);
            multipleChoiceContainer.appendChild(multipleChoiceLabel);

            // Label für die Optionen
            const label = document.createElement("label");
            label.textContent = "Auswahlmöglichkeiten";
            label.style.display = "block";
            label.style.marginBottom = "4px";
            label.style.fontSize = "12px";

            // Container für Input und Button
            const inputContainer = document.createElement("div");
            inputContainer.style.display = "flex";
            inputContainer.style.marginBottom = "10px";
            inputContainer.style.gap = "5px";

            // Textfeld für neue Optionen
            const input = document.createElement("input");
            input.type = "text";
            input.style.flex = "1";
            input.placeholder = "Neue Auswahlmöglichkeit eingeben";

            // Hinzufügen Button
            const addButton = document.createElement("button");
            addButton.textContent = "Hinzufügen";
            addButton.style.padding = "4px 8px";

            // Container für die Optionsliste
            const optionsContainer = document.createElement("div");
            optionsContainer.style.maxHeight = "150px";
            optionsContainer.style.overflowY = "auto";
            optionsContainer.style.padding = "4px";

            // Event Listener für das Hinzufügen
            addButton.addEventListener("click", () => {
                if (input.value.trim()) {
                    this.addOption(input.value.trim());
                    input.value = "";
                    this.repositionAllFields();
                }
            });

            // Enter-Taste auch zum Hinzufügen nutzen
            input.addEventListener("keypress", (e) => {
                if (e.key === "Enter" && input.value.trim()) {
                    this.addOption(input.value.trim());
                    input.value = "";
                    this.repositionAllFields();
                }
            });

            wrapper.appendChild(multipleChoiceContainer);
            wrapper.appendChild(label);
            inputContainer.appendChild(input);
            inputContainer.appendChild(addButton);
            wrapper.appendChild(inputContainer);
            wrapper.appendChild(optionsContainer);

            this.optionsContainer = optionsContainer;
            this.bodyEl.appendChild(wrapper);
        }

        readdOptions() {
            this.options.forEach(input => {
                this.addOption(input.trim());
            })
        }

        addOption(text) {
            const optionDiv = document.createElement("div");
            optionDiv.style.display = "flex";
            optionDiv.style.justifyContent = "space-between";
            optionDiv.style.alignItems = "center";
            optionDiv.style.padding = "4px";
            optionDiv.style.marginBottom = "4px";
            optionDiv.style.backgroundColor = "#f5f5f5";
            optionDiv.style.borderRadius = "4px";
            optionDiv.style.cursor = "move";

            optionDiv.draggable = true;

            // Radio/Checkbox Vorschau
            const inputPreview = document.createElement("input");
            inputPreview.type = this.allowMultiple ? "checkbox" : "radio";
            inputPreview.name = "preview_" + this.instanceId;
            inputPreview.style.marginRight = "8px";
            inputPreview.style.cursor = "default";
            inputPreview.onclick = (e) => e.preventDefault();

            //Layout
            const optionText = document.createElement("span");
            optionText.textContent = text;
            optionText.style.fontSize = "12px";
            optionText.style.flex = "1";
            optionText.style.pointerEvents = "none";

            //Delete Button Format
            const deleteButton = document.createElement("button");
            deleteButton.textContent = "×";
            deleteButton.style.padding = "2px 6px";
            deleteButton.style.backgroundColor = "#ff4444";
            deleteButton.style.color = "white";
            deleteButton.style.border = "none";
            deleteButton.style.borderRadius = "3px";
            deleteButton.style.cursor = "pointer";
            deleteButton.style.marginLeft = "8px";

            // Drag & Drop Event Listener
            this.addDragListeners(optionDiv);

            deleteButton.addEventListener("click", () => {
                optionDiv.remove();
                this.updateOptions();
            });

            const textContainer = document.createElement("div");
            textContainer.style.display = "flex";
            textContainer.style.alignItems = "center";
            textContainer.style.flex = "1";
            textContainer.appendChild(inputPreview);
            textContainer.appendChild(optionText);

            optionDiv.appendChild(textContainer);
            optionDiv.appendChild(deleteButton);
            this.optionsContainer.appendChild(optionDiv);

            this.updateOptions();
        }

        addDragListeners(optionDiv) {
            optionDiv.addEventListener('dragstart', (e) => {
                e.target.classList.add('dragging');
                e.target.style.opacity = '0.5';
            });

            optionDiv.addEventListener('dragend', (e) => {
                e.target.classList.remove('dragging');
                e.target.style.opacity = '1';
                this.updateOptions();
            });

            optionDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                const draggingItem = this.optionsContainer.querySelector('.dragging');
                const siblings = [...this.optionsContainer.querySelectorAll('div:not(.dragging)')];
                const nextSibling = siblings.find(sibling => {
                    const box = sibling.getBoundingClientRect();
                    const offset = e.clientY - box.top - box.height / 2;
                    return offset < 0;
                });

                if (nextSibling) {
                    this.optionsContainer.insertBefore(draggingItem, nextSibling);
                } else {
                    this.optionsContainer.appendChild(draggingItem);
                }
            });

            optionDiv.addEventListener('dragenter', (e) => {
                e.preventDefault();
                optionDiv.style.borderTop = '2px solid #007bff';
            });

            optionDiv.addEventListener('dragleave', (e) => {
                e.preventDefault();
                optionDiv.style.borderTop = 'none';
            });

            optionDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                optionDiv.style.borderTop = 'none';
            });
        }

        updateOptionsPreview() {
            const inputs = this.optionsContainer.querySelectorAll('input');
            inputs.forEach(input => {
                input.type = this.allowMultiple ? "checkbox" : "radio";
            });
        }

        updateOptions() {
            this.options = Array.from(this.optionsContainer.querySelectorAll("span"))
                .map(span => span.textContent);
            updateFieldProperties(this.instanceId, {options: this.options})
        }

        toConfigObject() {
            const baseConfig = super.toConfigObject();
            return {
                ...baseConfig,
                options: this.options,
                allowMultiple: this.allowMultiple
            };
        }
    }


    // Funktionen zum Erstellen der verschiedenen Feldtypen mit versetzten Positionen
    let fieldOffsetCounter = 0;
    let lastFieldHeight = 0;
    let currentYPosition = 0;

    function calculateNextPosition() {
        const container = document.getElementById("form-builder");
        const allFields = container.querySelectorAll(".field");

        if (allFields.length === 0) {
            currentYPosition = 0;
            return 0;
        }

        // Finde das unterste Feld
        let maxBottom = 0;
        allFields.forEach(field => {
            const top = parseInt(field.style.top) || 0;
            const height = field.offsetHeight;
            const bottom = top + height;
            if (bottom > maxBottom) {
                maxBottom = bottom;
            }
        });

        // Füge einen kleinen Abstand hinzu
        currentYPosition = maxBottom + 10;
        return currentYPosition;
    }

    function addTextField() {
        new Textfield({
            title: "",
            infoText: "",
            required: false,
            x: 0,
            y: calculateNextPosition()
        });
    }

    function addInfoField() {
        new InfoField({
            title: "",
            infoText: "",
            required: false,
            x: 0,
            y: calculateNextPosition()
        });
    }

    function addFileField() {
        new FileField({
            title: "",
            infoText: "",
            required: false,
            x: 0,
            y: calculateNextPosition()
        });
    }

    function addNumberField() {
        new NumberField({
            title: "",
            infoText: "",
            required: false,
            x: 0,
            y: calculateNextPosition()
        });
    }

    function addDateField() {
        new DateField({
            title: "",
            infoText: "",
            required: false,
            x: 0,
            y: calculateNextPosition()
        });
    }

    function addPictureField() {
        new PictureField({
            title: "",
            infoText: "",
            required: false,
            x: 0,
            y: calculateNextPosition()
        });
    }

    function addDropdownField() {
        new DropDownfield({
            title: "",
            infoText: "",
            required: false,
            x: 0,
            y: calculateNextPosition()
        });
    }

    function addMultipleChoiceField() {
        new Radio_MultipleChoicefield({
            title: "",
            infoText: "",
            required: false,
            x: 0,
            y: calculateNextPosition()
        });
    }

    // Drag & Drop für den Container aktivieren
    const formBuilder = document.getElementById("form-builder");

    formBuilder.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    });

    formBuilder.addEventListener('drop', (e) => {
        e.preventDefault();
    });
</script>
<script>
    let specs = {
        "vars": {
            "id-counter": 0,
            "title": "",
            "image": null
        },
        "form": {
            "fields": [],
            "scripts": []
        },
        "eval": {
            "fields": [],
            "scripts": []
        }
    }

    document.getElementById("logo").onchange = function (event) {
        let file = this.files[0];
        let reader = new FileReader();

        reader.onload = function (event) {
            specs["vars"]["image"] = event.target.result;
            let preview = document.getElementById("preview");
            preview.src = event.target.result;
        };

        reader.readAsDataURL(file);
    }
    document.getElementById("title").onchange = function () {
        specs["vars"]["title"] = document.getElementById("title").value;
    }


    function render(givenSpecs = null, formType = "form") {
        let container = document.getElementById("form-builder");
        container.innerHTML = "";

        let formSpecs = givenSpecs[formType]["fields"]
        if (givenSpecs === null) {
            formSpecs = specs[formType]["fields"];
        }

        document.getElementById("title").value = specs["vars"]["title"];
        document.getElementById("preview").src = specs["vars"]["image"];

        for (let i = 0; i < formSpecs.length; i++) {
            renderField(formSpecs[i]["class"], formSpecs[i]["config"]);
        }

        if (givenSpecs !== null)
            specs = givenSpecs;
    }

    function renderField(type, args) {
        switch (type) {
            case "Textfield":
                return new Textfield(args);
            case "DropDownfield":
                return new DropDownfield(args);
            case "DateField":
                return new DateField(args);
            case "InfoField":
                return new InfoField(args);
            case "PictureField":
                return new PictureField(args);
            case "FileField":
                return new FileField(args);
            case "NumberField":
                return new NumberField(args);
            case "Radio_MultipleChoicefield":
                return new Radio_MultipleChoicefield(args);
            default:
                return null;
        }
    }

    function insertField(field, formType = "form") {
        let id = field.getID();
        let pos = getFieldPos(id);
        if (pos != null) {
            return updateField(field, formType);
        } else {
            let pos = specs[formType]["fields"].length;
            specs[formType]["fields"][pos] = {
                "id": id,
                "class": field.constructor.name,
                "htmlType": "body",
                "config": field.toConfigObject(),
                "files": field.getFiles()
            }
            return true;
        }
    }

    function updateFieldProperties(fieldID, attributes, formType = "form") {
        if (attributes === null)
            return;
        let pos = getFieldPos(fieldID);
        if (pos === null)
            return;
        specs[formType]["fields"][pos]["config"] = {...specs[formType]["fields"][pos]["config"], ...attributes};
    }

    function moveField(fieldID, targetPos = null, formType = "form", pos = null) {
        if (pos == null)
            pos = getFieldPos(fieldID);

        if (targetPos == null)
            targetPos = specs[formType]["fields"].length - 1;

        if (targetPos === pos)
            return true;

        let fieldSpecs = specs[formType]["fields"][pos];
        if (targetPos < pos) {
            while (targetPos < pos) {
                specs[formType]["fields"][pos] = specs[formType]["fields"][pos - 1];
                pos--;
            }
            specs[formType]["fields"][pos] = fieldSpecs;
        } else {
            while (targetPos > pos) {
                specs[formType]["fields"][pos] = specs[formType]["fields"][pos + 1];
                pos++;
            }
            specs[formType]["fields"][pos] = fieldSpecs;
        }

        return true;
    }

    function updateField(field, formType = "form", pos = null) {
        if (field == null || !(field instanceof BaseField))
            return false;

        if (pos == null)
            pos = getFieldPos(field.getID());

        let fieldSpecs = specs[formType]["fields"][pos];
        fieldSpecs["htmlType"] = "body";
        fieldSpecs["config"] = field.toConfigObject();
        fieldSpecs["files"] = field.getFiles();

        return true;
    }

    function getFieldPos(fieldID, formType = "form") {
        let fields = specs[formType]["fields"];
        if (fields != null) {
            let i = 0;
            while (i < fields.length) {
                if (fields[i] != null && fields[i]["id"] == fieldID)
                    return i;
                i++;
            }
        } else {
            return null;
        }
    }

    function removeField(field, formType = "form") {
        if (field == null || !(field instanceof BaseField))
            return false;

        let fields = specs[formType]["fields"];
        moveField(field.getID(), fields.length - 1);
        fields.pop();
    }

</script>
<script>
    // script for updating and saving
    function downloadBuilder() {
        let jsonLink = document.createElement('a');
        jsonLink.href = URL.createObjectURL(new File([getSpecsBlob()], "specs.json"));
        jsonLink.download = 'specs.json';
        jsonLink.click();
    }

    function exportBuilder() {
        let title = document.getElementById("title").value
        let formLink = document.createElement('a');
        formLink.href = URL.createObjectURL(new File([getFormBlob()], `${title}-Formular.html`));
        formLink.download = `${title}-Formular.html`;
        formLink.click();

        let auswertungLink = document.createElement('a');
        auswertungLink.href = URL.createObjectURL(new File([createEvalBlob()], "auswertung.html"));
        auswertungLink.download = `${title}-Auswertung.html`;
        auswertungLink.click();
    }

    function importBuilder() {
        let file = document.getElementById("importFile").files[0];
        if (file) {
            let reader = new FileReader();
            reader.readAsText(file, "UTF-8");
            reader.onloadend = function (evt) {
                let loadedSpecs = JSON.parse(evt.target.result);
                console.log(loadedSpecs);
                render(loadedSpecs);
            }
        }
    }


    function getSpecsBlob() {
        let jsonSpecs = new JsonObj(specs);
        return jsonSpecs.getDownloadFile();
    }

    function getFormBlob() {
        let htmlForm = new HtmlObj()
        htmlForm.appendBody(createFormHtml(specs));
        htmlForm.finish();
        return htmlForm.getDownloadFile();
    }

    class Obj {
        constructor() {

        }

        getDownloadFile(data, type) {
            return new Blob([data], {type: type});
        }
    }

    class HtmlObj extends Obj {
        fullHtml = "";
        htmlHeader = "<header>";
        htmlBody = "<body>";
        htmlFooter = "<footer>";

        constructor(html = "<!DOCTYPE html><html lang=\"de\">") {
            super();
            this.fullHtml = html;
        }

        append(jsonHtml) {
            if (jsonHtml != null && typeof jsonHtml === 'object' && jsonHtml.html) {
                if (jsonHtml.type && jsonHtml.type === "header") {
                    this.htmlHeader += jsonHtml.html;
                } else if (jsonHtml.type && jsonHtml.type === "body") {
                    this.htmlBody += jsonHtml.html;
                } else if (jsonHtml.type && jsonHtml.type === "footer") {
                    this.htmlFooter += jsonHtml.html;
                }
            }
            return this;
        }

        finish() {
            this.htmlHeader += "</header>";
            this.htmlBody += "</body>";
            this.htmlFooter += "</footer>";
            this.fullHtml += this.htmlHeader + this.htmlBody + this.htmlFooter + "</html>";
            return this;
        }

        getDownloadFile() {
            return super.getDownloadFile(this.fullHtml, 'text/html');
        }

        getContent() {
            return this.fullHtml;
        }

        appendBody(html) {
            this.htmlBody += html;
        }
    }

    class JsonObj extends Obj {
        json = {}

        constructor(json) {
            super();
            this.json = json;
        }

        getDownloadFile() {
            return super.getDownloadFile(JSON.stringify(this.json), 'application/json');
        }

        getContent() {
            return this.json;
        }
    }

    document.getElementById("saveBtn").onclick = function () {
        downloadBuilder()
    };
    document.getElementById("exportBtn").onclick = function () {
        exportBuilder()
    };
    document.getElementById("importFile").onchange = function () {
        importBuilder();
        document.getElementById("importFile").value = "";
    };
</script>
<script>
    function createEvalHtml() {
        let title = document.getElementById("title").value
        let logo = document.getElementById("logo")
        return `<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>${title}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .title-box {
            background: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .title-box h1 {
            margin: 0;
            font-size: 28px;
        }

        .upload-box {
            background: white;
            padding: 20px;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .upload-btn {
            background-color: #04AA6D;
            color: white;
            padding: 16px 32px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 5px;
        }

        .upload-btn:hover {
            background-color: #3e8e41;
        }

        .zip-btn {
            background-color: #ff8800;
        }

        .zip-btn:hover {
            background-color: #cc6600;
        }

        #fileInput, #zipInput {
            display: none;
        }

        .matrix-container {
            background: white;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid black;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background-color: #f5f5f5;
        }

        tr:hover {
            background-color: #e9ecef;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .error-message {
            background: #ff4444;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }

        .success-message {
            background: #04AA6D;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }

        .file-info {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
        .dropdown {
            position: relative;
            top: 0;
            left: 0;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: fixed;
            background-color: #f1f1f1;
            min-width: 160px;
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
            z-index: 2;
        }

        .dropdown-content button {
            color: black;
            width: 100%;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown-content button:hover {background-color: #ddd;}
        .dropdown:hover .dropdown-content {display: block;}
        .dropdown:hover .dropbtn {background-color: #3e8e41;}
    </style>
</head>
<body>
<div class="container">
    <div class="title-box">
        <h1>${title}</h1>
        <img src="${specs["vars"]["image"]}" alt="" height="100" width=auto></img>
    </div>

    <div class="upload-box">
        <input type="file" id="fileInput" accept=".json" multiple>
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
            JSON Dateien hochladen
        </button>

        <input type="file" id="zipInput" accept=".zip" multiple>
        <button class="upload-btn zip-btn" onclick="document.getElementById('zipInput').click()">
            ZIP Dateien hochladen
        </button>

        <div class="dropdown">
            <button class="upload-btn">Exportieren</button>
            <div class="dropdown-content">
                <button onclick="exportCsv()">CSV</button>
                <button onclick="exportPdf()">PDF</button>
            </div>
        </div>

        <button class="upload-btn" onclick="exportSpecs()">Fragebogen wiederherstellen</button>

        <div class="file-info" id="fileInfo"></div>
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
    </div>

    <div class="matrix-container">
        <div id="tableContainer">
            <div class="no-data">Bitte laden Sie JSON- oder ZIP-Dateien, um die Auswertung anzuzeigen.</div>
        </div>
    </div>
</div>

<script>
    let allData = [];
    let fieldTitles = [];

    const specs = ${JSON.stringify(specs)};


    function exportSpecs() {
        let jsonLink = document.createElement('a');
        jsonLink.href = URL.createObjectURL(new File([new Blob([JSON.stringify(this.json)], {type: 'application/json'})], "specs.json"));
        jsonLink.download = 'specs.json';
        jsonLink.click();
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const files = e.target.files;
        if (files.length === 0) return;

        allData = [];
        fieldTitles = [];

        const fileInfo = document.getElementById('fileInfo');
        fileInfo.textContent = \`\${files.length} JSON-Datei(en) ausgewählt\`;

        let filesProcessed = 0;

        Array.from(files).forEach(file => {
            const reader = new FileReader();

            reader.onload = function(event) {
                try {
                    const jsonData = JSON.parse(event.target.result);
                    processJsonData(jsonData, file.name);
                    filesProcessed++;

                    if (filesProcessed === files.length) {
                        generateTable();
                    }
                } catch (error) {
                    showError(\`Fehler beim Laden von \${file.name}: \${error.message}\`);
                }
            };

            reader.onerror = function() {
                showError(\`Fehler beim Lesen von \${file.name}\`);
            };

            reader.readAsText(file);
        });
    });

    document.getElementById('zipInput').addEventListener('change', async function(e) {
        const files = e.target.files;
        if (files.length === 0) return;

        allData = [];
        fieldTitles = [];

        let totalJsonFiles = 0;

        for (const file of files) {
            try {
                const jsonFiles = await processZipFile(file);
                totalJsonFiles += jsonFiles;
            } catch (error) {
                showError(\`Fehler beim Verarbeiten von \${file.name}: \${error.message}\`);
            }
        }

        if (totalJsonFiles > 0) {
            showSuccess(\`\${files.length} ZIP-Datei(en) verarbeitet, \${totalJsonFiles} JSON-Datei(en) gefunden\`);
            generateTable();
        } else {
            showError('Keine JSON-Dateien in den ZIP-Archiven gefunden');
        }

        document.getElementById('zipInput').value = '';
    });

    async function processZipFile(zipFile) {
        const arrayBuffer = await zipFile.arrayBuffer();
        const jsonFiles = await extractJsonFromZip(arrayBuffer);
        
        jsonFiles.forEach(jsonFile => {
            try {
                const jsonData = JSON.parse(jsonFile.content);
                processJsonData(jsonData, jsonFile.name);
            } catch (error) {
                console.error(\`Fehler beim Parsen von \${jsonFile.name}:\`, error);
            }
        });

        return jsonFiles.length;
    }

    async function extractJsonFromZip(arrayBuffer) {
        const view = new DataView(arrayBuffer);
        const jsonFiles = [];
        let offset = 0;

        while (offset < arrayBuffer.byteLength - 4) {
            const signature = view.getUint32(offset, true);

            if (signature === 0x04034b50) {
                const compressionMethod = view.getUint16(offset + 8, true);
                const compressedSize = view.getUint32(offset + 18, true);
                const uncompressedSize = view.getUint32(offset + 22, true);
                const fileNameLength = view.getUint16(offset + 26, true);
                const extraFieldLength = view.getUint16(offset + 28, true);

                const fileNameStart = offset + 30;
                const fileNameBytes = new Uint8Array(arrayBuffer, fileNameStart, fileNameLength);
                const fileName = new TextDecoder().decode(fileNameBytes);

                const dataStart = fileNameStart + fileNameLength + extraFieldLength;

                if (fileName.toLowerCase().endsWith('.json') && !fileName.includes('__MACOSX') && !fileName.endsWith('/')) {
                    try {
                        let content;
                        const compressedData = new Uint8Array(arrayBuffer, dataStart, compressedSize);

                        if (compressionMethod === 0) {
                            content = new TextDecoder().decode(compressedData);
                        } else if (compressionMethod === 8) {
                            const decompressed = await decompressDeflate(compressedData);
                            content = new TextDecoder().decode(decompressed);
                        } else {
                            console.warn(\`Nicht unterstützte Komprimierung (\${compressionMethod}) für: \${fileName}\`);
                            offset = dataStart + compressedSize;
                            continue;
                        }

                        jsonFiles.push({ name: fileName, content: content });
                    } catch (error) {
                        console.error(\`Fehler beim Extrahieren von \${fileName}:\`, error);
                    }
                }

                offset = dataStart + compressedSize;
            } else {
                offset++;
            }
        }

        return jsonFiles;
    }

    async function decompressDeflate(compressedData) {
        if (typeof DecompressionStream !== 'undefined') {
            const ds = new DecompressionStream('deflate-raw');
            const writer = ds.writable.getWriter();
            writer.write(compressedData);
            writer.close();

            const chunks = [];
            const reader = ds.readable.getReader();
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                chunks.push(value);
            }

            const totalLength = chunks.reduce((acc, chunk) => acc + chunk.length, 0);
            const result = new Uint8Array(totalLength);
            let offset = 0;
            for (const chunk of chunks) {
                result.set(chunk, offset);
                offset += chunk.length;
            }

            return result;
        } else {
            throw new Error('Komprimierte ZIP-Dateien werden in diesem Browser nicht unterstützt');
        }
    }

    function processJsonData(data, fileName) {
        const rowData = {
            fileName: fileName,
            values: {}
        };

        if (data.form && data.form.fields && Array.isArray(data.form.fields)) {
            data.form.fields.forEach(field => {
                const title = field.config.title || field.class || 'Unbekannt';
                const value = getFieldValue(field.config);

                if (!fieldTitles.includes(title)) {
                    fieldTitles.push(title);
                }
                rowData.values[title] = value;
            });
        } else if (data && Array.isArray(data)) {
            data.forEach(field => {
                const title = field.title || 'Unbekannt';
                if (!fieldTitles.includes(title)) {
                    fieldTitles.push(title);
                }
                rowData.values[title] = field.value;
            });
        } else {
            console.warn('Keine Felder in:', fileName, data);
        }

        allData.push(rowData);
    }

    function getFieldValue(field) {
        if (field.value !== undefined && field.value !== null && field.value !== '') {
            return field.value;
        }
        if (field.options && Array.isArray(field.options)) {
            return field.options.join(', ');
        }
        return '-';
    }

    function generateTable() {
        const tableContainer = document.getElementById('tableContainer');

        if (allData.length === 0 || fieldTitles.length === 0) {
            tableContainer.innerHTML = '<div class="no-data">Keine Daten gefunden.</div>';
            return;
        }

        let tableHTML = '<table><thead><tr>';
        tableHTML += '<th>Dateiname</th>';

        fieldTitles.forEach(title => {
            tableHTML += \`<th>\${escapeHtml(title)}</th>\`;
        });

        tableHTML += '</tr></thead><tbody>';

        allData.forEach(row => {
            tableHTML += '<tr>';
            tableHTML += \`<td>\${escapeHtml(row.fileName)}</td>\`;

            fieldTitles.forEach(title => {
                const value = row.values[title] || '-';
                tableHTML += \`<td>\${escapeHtml(String(value))}</td>\`;
            });

            tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table>';
        tableContainer.innerHTML = tableHTML;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';

        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = message;
        successDiv.style.display = 'block';

        setTimeout(() => {
            successDiv.style.display = 'none';
        }, 5000);
    }
<` + `/script>
    <script>
        function exportPdf() {
            let table = document.getElementById("tableContainer").innerHTML;
            let printWindow = window.open("", "", "height=500, width=500");
            printWindow.document.open();
            const htmlContent = '<html lang="De">\\n' +
                '<head>\\n' +
                '<title>${title}</title>\\n' +
                '<style>\\n' +
                'body { font-family: Arial, sans-serif; }\\n' +
                'h1 { color: #333; }\\n' +
                'th, td {\\n' +
                'border: 1px solid black;\\n' +
                'padding: 12px;\\n' +
                'text-align: left;\\n' +
                '}\\n' +
                '</style>\\n' +
                '</head>\\n' +
                '<body>\\n' +
                '<h1>${title}</h1>\\n' +
                table +
                '</body>\\n' +
                '</html>';

            printWindow.document.write(htmlContent)
            printWindow.document.close();
            printWindow.print();
        }

        function exportCsv() {
            let csv_data = [];
            let rows = document.getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                let cols = rows[i].querySelectorAll("td,th");

                let csvrow = [];
                for (let j = 0; j < cols.length; j++) {
                    csvrow.push(cols[j].innerHTML);
                }

                csv_data.push(csvrow.join(","));
            }

            csv_data = csv_data.join("\\n");

            downloadCsv(csv_data)

        }

        function downloadCsv(csv_data) {
            CSVFile = new Blob([csv_data], {type: "text/csv"});

            let temp_link = document.createElement('a');

            temp_link.download = \`${title}.csv\`;
        let url = window.URL.createObjectURL(CSVFile);
        temp_link.href = url;

        temp_link.style.display = "none";
        document.body.appendChild(temp_link);

        temp_link.click();
        document.body.removeChild(temp_link);
    }

<` + `/script>
</body>
</html>`;
    }

    function createEvalBlob() {
        const htmlEval = createEvalHtml();
        return new Blob([htmlEval], {type: 'text/html'});
    }
</script>
<script>
    function createFormHtml(specs) {
        let title = document.getElementById("title").value
        return `<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>${title}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
         .title-box {
            background: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
         .title-box h1 {
            margin: 0;
            font-size: 28px;
        }
        .field {
            background: #ffffff;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            padding: 15px;
        }
        .field-header {
            background: #007bff;
            color: #fff;
            padding: 8px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 6px 6px 0 0;
            margin: -15px -15px 10px -15px;
        }
        .field-title {
            font-size: 14px;
            font-weight: bold;
        }
        .field-title-label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            position: relative;
        }
        
        /* Tooltip für Zusatzinfo */
        .field-title-label[data-info]:hover::after {
            content: attr(data-info);
            position: absolute;
            left: 0;
            top: 130%;
            background: #333;
            color: #fff;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: normal;
            max-width: 300px;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .field-required {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }
        .field-required-label {
            position: absolute;
            top: 0;
            right: 0;
            color: black;
            font-size: 12px;
            font-weight: bold;
        }
        .field-required-indicator {
            color: #ffeb3b;
            font-size: 14px;
        }
        .field-body {
            padding: 10px 0;
            position: relative;
        }
        label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        img {
            max-width: 100%;
            height: auto;
        }
        .upload-box {
            background: white;
            padding: 20px;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .upload-btn {
            background-color: #04AA6D;
            color: white;
            padding: 16px 32px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 5px;
        }
        .upload-btn:hover {
            background-color: #3e8e41;
        }
        .submit-btn {
            background-color: #007bff;
        }
        .submit-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="title-box">
        <h1>${specs["vars"]["title"]}</h1>
        <img src="${specs["vars"]["image"]}" alt="" width=auto style="max-height:100px "></img>
    </div>
    <div class="upload-box">
        <!--button class="upload-btn" onclick="exportSpecs()">Fragebogen wiederherstellen</button-->
        <button class="upload-btn submit-btn" onclick="exportFormAsZip()">Formular als ZIP exportieren</button>

    </div>
    <div id="form-builder"></div>
    <script>
        const specs = ${JSON.stringify(specs)};
        let uploadedFiles = {};

    function exportSpecs() {
        let jsonLink = document.createElement('a');
        jsonLink.href = URL.createObjectURL(new File([new Blob([JSON.stringify(specs)], {type: 'application/json'})], "specs.json"));
        jsonLink.download = 'specs.json';
        jsonLink.click();
    }

    // ZIP-Erstellung Funktionen (ohne externe Bibliotheken)
    function createZipFile(files) {
        const zipParts = [];
        const centralDirectory = [];
        let offset = 0;

        files.forEach(file => {
            const fileData = file.data;
            const fileName = file.name;
            const fileNameBytes = new TextEncoder().encode(fileName);
            
            // Local file header signature
            const localFileHeader = new Uint8Array(30 + fileNameBytes.length);
            const view = new DataView(localFileHeader.buffer);
            
            view.setUint32(0, 0x04034b50, true); // Local file header signature
            view.setUint16(4, 20, true); // Version needed to extract
            view.setUint16(6, 0, true); // General purpose bit flag
            view.setUint16(8, 0, true); // Compression method (0 = no compression)
            view.setUint16(10, 0, true); // File last modification time
            view.setUint16(12, 0, true); // File last modification date
            view.setUint32(14, crc32(fileData), true); // CRC-32
            view.setUint32(18, fileData.length, true); // Compressed size
            view.setUint32(22, fileData.length, true); // Uncompressed size
            view.setUint16(26, fileNameBytes.length, true); // File name length
            view.setUint16(28, 0, true); // Extra field length
            
            localFileHeader.set(fileNameBytes, 30);
            
            zipParts.push(localFileHeader);
            zipParts.push(fileData);
            
            // Central directory header
            const centralDirHeader = new Uint8Array(46 + fileNameBytes.length);
            const cdView = new DataView(centralDirHeader.buffer);
            
            cdView.setUint32(0, 0x02014b50, true); // Central directory signature
            cdView.setUint16(4, 20, true); // Version made by
            cdView.setUint16(6, 20, true); // Version needed to extract
            cdView.setUint16(8, 0, true); // General purpose bit flag
            cdView.setUint16(10, 0, true); // Compression method
            cdView.setUint16(12, 0, true); // File last modification time
            cdView.setUint16(14, 0, true); // File last modification date
            cdView.setUint32(16, crc32(fileData), true); // CRC-32
            cdView.setUint32(20, fileData.length, true); // Compressed size
            cdView.setUint32(24, fileData.length, true); // Uncompressed size
            cdView.setUint16(28, fileNameBytes.length, true); // File name length
            cdView.setUint16(30, 0, true); // Extra field length
            cdView.setUint16(32, 0, true); // File comment length
            cdView.setUint16(34, 0, true); // Disk number start
            cdView.setUint16(36, 0, true); // Internal file attributes
            cdView.setUint32(38, 0, true); // External file attributes
            cdView.setUint32(42, offset, true); // Relative offset of local header
            
            centralDirHeader.set(fileNameBytes, 46);
            centralDirectory.push(centralDirHeader);
            
            offset += localFileHeader.length + fileData.length;
        });
        
        const centralDirData = new Uint8Array(centralDirectory.reduce((sum, cd) => sum + cd.length, 0));
        let cdOffset = 0;
        centralDirectory.forEach(cd => {
            centralDirData.set(cd, cdOffset);
            cdOffset += cd.length;
        });
        
        zipParts.push(centralDirData);
        
        // End of central directory record
        const endOfCentralDir = new Uint8Array(22);
        const eocdView = new DataView(endOfCentralDir.buffer);
        
        eocdView.setUint32(0, 0x06054b50, true); // End of central dir signature
        eocdView.setUint16(4, 0, true); // Number of this disk
        eocdView.setUint16(6, 0, true); // Disk where central directory starts
        eocdView.setUint16(8, files.length, true); // Number of central directory records on this disk
        eocdView.setUint16(10, files.length, true); // Total number of central directory records
        eocdView.setUint32(12, centralDirData.length, true); // Size of central directory
        eocdView.setUint32(16, offset, true); // Offset of start of central directory
        eocdView.setUint16(20, 0, true); // Comment length
        
        zipParts.push(endOfCentralDir);
        
        return new Blob(zipParts, { type: 'application/zip' });
    }

    function crc32(data) {
        const table = new Uint32Array(256);
        for (let i = 0; i < 256; i++) {
            let c = i;
            for (let j = 0; j < 8; j++) {
                c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
            }
            table[i] = c;
        }
        
        let crc = 0xFFFFFFFF;
        for (let i = 0; i < data.length; i++) {
            crc = table[(crc ^ data[i]) & 0xFF] ^ (crc >>> 8);
        }
        return (crc ^ 0xFFFFFFFF) >>> 0;
    }

    // Füge diese Funktion vor exportFormAsZip() hinzu (um Zeile 2380)
function validateRequiredFields() {
    const formSpecs = specs.form.fields;
    const missingFields = [];
    
    for (let i = 0; i < formSpecs.length; i++) {
        const fieldSpec = formSpecs[i];
        
        // Überspringe nicht-Pflichtfelder und InfoFelder/PictureFelder
        if (!fieldSpec.config.required || 
            fieldSpec.class === 'InfoField' || 
            fieldSpec.class === 'PictureField') {
            continue;
        }
        
        const fieldId = fieldSpec.config.id;
        const fieldElement = document.getElementById('field_' + fieldId);
        const fieldTitle = fieldSpec.config.title || 'Unbenanntes Feld';
        
        let isEmpty = false;
        
        if (fieldSpec.class === 'Textfield' || 
            fieldSpec.class === 'NumberField' || 
            fieldSpec.class === 'DateField') {
            isEmpty = !fieldElement || !fieldElement.value || fieldElement.value.trim() === '';
        } else if (fieldSpec.class === 'DropDownfield') {
            isEmpty = !fieldElement || !fieldElement.value;
        } else if (fieldSpec.class === 'FileField') {
            isEmpty = !fieldElement || !fieldElement.files || fieldElement.files.length === 0;
        } else if (fieldSpec.class === 'Radio_MultipleChoicefield') {
            if (fieldSpec.config.allowMultiple) {
                const checkboxes = document.querySelectorAll('input[name="field_' + fieldId + '"]:checked');
                isEmpty = checkboxes.length === 0;
            } else {
                const radio = document.querySelector('input[name="field_' + fieldId + '"]:checked');
                isEmpty = !radio;
            }
        }
        
        if (isEmpty) {
            missingFields.push(fieldTitle);
        }
    }
    
    return missingFields;
}

// Ändere exportFormAsZip() (um Zeile 2381)
async function exportFormAsZip() {
    try {
        // Validiere Pflichtfelder
        const missingFields = validateRequiredFields();
        
        if (missingFields.length > 0) {
            const fieldList = missingFields.map(field => '- ' + field).join('\\n');
            alert('Bitte füllen Sie alle Pflichtfelder aus:\\n\\n' + fieldList);
            return;
        }
        
        const formData = await collectFormData();
        const files = [];
        
        // JSON-Datei hinzufügen
        const jsonString = JSON.stringify(formData, null, 2);
        const jsonBytes = new TextEncoder().encode(jsonString);
        files.push({
            name: 'formular.json',
            data: jsonBytes
        });
        
        // Hochgeladene Dateien hinzufügen
        for (const [fileName, fileData] of Object.entries(uploadedFiles)) {
            files.push({
                name: fileName,
                data: fileData
            });
        }
        
        const zipBlob = createZipFile(files);
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = '${specs["vars"]["title"] || "formular"}_ausgefuellt.zip';
        link.click();
        
        alert('Formular erfolgreich als ZIP exportiert!');
    } catch (error) {
        console.error('Fehler beim Export:', error);
        alert('Fehler beim Exportieren des Formulars: ' + error.message);
    }
}

async function collectFormData() {
    const formSpecs = specs.form.fields;
    const result = {
        form: {
            fields: []
            }
        };
        
        for (let i = 0; i < formSpecs.length; i++) {
            const fieldSpec = formSpecs[i];
            const fieldId = fieldSpec.config.id;
            const fieldElement = document.getElementById('field_' + fieldId);
            
            let value = null;
            
            if (fieldSpec.class === 'Textfield' || fieldSpec.class === 'NumberField' || fieldSpec.class === 'DateField') {
                value = fieldElement ? fieldElement.value : '';
            } else if (fieldSpec.class === 'DropDownfield') {
                value = fieldElement ? fieldElement.value : '';
            } else if (fieldSpec.class === 'FileField') {
                if (fieldElement && fieldElement.files && fieldElement.files[0]) {
                    const file = fieldElement.files[0];
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);
                    uploadedFiles[file.name] = uint8Array;
                    value = file.name;
                }
            } else if (fieldSpec.class === 'Radio_MultipleChoicefield') {
                if (fieldSpec.config.allowMultiple) {
                    const checkboxes = document.querySelectorAll('input[name="field_' + fieldId + '"]:checked');
                    value = Array.from(checkboxes).map(cb => cb.value);
                } else {
                    const radio = document.querySelector('input[name="field_' + fieldId + '"]:checked');
                    value = radio ? radio.value : '';
                }
            } else if (fieldSpec.class === 'InfoField' || fieldSpec.class === 'PictureField') {
                value = fieldSpec.config.value;
            }
            
            result.form.fields.push({
                class: fieldSpec.class,
                config: {
                    ...fieldSpec.config,
                    value: value
                }
            });
        }
        
        return result;
    }

        function renderForm(givenSpecs, formType = "form") {
            const container = document.getElementById("form-builder");
            if (!container) {
                console.error('Container #form-builder nicht gefunden');
                return;
            }
            container.innerHTML = "";

            const formSpecs = givenSpecs[formType]["fields"];

            for(let i = 0; i < formSpecs.length; i++){
                renderFormField(formSpecs[i]["class"], formSpecs[i]["config"]);
            }
        }

        function renderFormField(type, config){
            switch (type){
                case "Textfield":
                    return new TextFormField(config);
                case "DropDownfield":
                    return new DropdownFormField(config);
                case "DateField":
                    return new DateFormField(config);
                case "InfoField":
                    return new InfoFormField(config);
                case "PictureField":
                    return new PictureFormField(config);
                case "FileField":
                    return new FileFormField(config);
                case "NumberField":
                    return new NumberFormField(config);
                case "Radio_MultipleChoicefield":
                    return new RadioMultipleChoiceFormField(config);
                default:
                    return null;
            }
        }

        class BaseFormField{
            constructor(config) {
                this.instanceId = config.id;
                this.type = config.type || "base";
                this.title = config.title || "";
                this.infoText = config.infoText || "";
                this.required = config.required || false;
                this.x = config.x || 0;
                this.y = config.y || 0;

                this.createFormField();
            }

            createFormField() {
                const container = document.getElementById("form-builder");

                this.el = document.createElement("div");
                this.el.className = "field";
                this.el.id = String(this.instanceId);

                const body = document.createElement("div");
                body.className = "field-body";
                
                // Titel mit Tooltip hinzufügen, wenn vorhanden
                if(this.title) {
                    const titleDiv = document.createElement("div");
                    titleDiv.className = "field-title-label";
                    titleDiv.textContent = this.title;
                    
                    // Füge Tooltip-Info hinzu, wenn vorhanden
                    if(this.infoText) {
                        titleDiv.setAttribute("data-info", this.infoText);
                    }
                    
                    body.appendChild(titleDiv);
                }
                
                // Pflicht-Label in den Body einfügen, wenn required
                if(this.required) {
                    const requiredLabel = document.createElement("span");
                    requiredLabel.className = "field-required-label";
                    requiredLabel.textContent = "Pflicht*";
                    body.appendChild(requiredLabel);
                }
                
                this.bodyEl = body;

                this.el.appendChild(body);
                container.appendChild(this.el);
            }
        }

        class TextFormField extends BaseFormField{
            constructor(config) {
                super(config);
                this.createTextInput();
            }

            createTextInput() {
                const wrapper = document.createElement("div");
                const label = document.createElement("label");

                const input = document.createElement("input");
                input.type = "text";
                input.id = "field_" + this.instanceId;

                wrapper.appendChild(label);
                wrapper.appendChild(input);
                this.bodyEl.appendChild(wrapper);
            }
        }

        class DropdownFormField extends BaseFormField{
            constructor(config) {
                super(config);
                this.options = config.options || [];
                this.createDropdownInput();
            }

            createDropdownInput(){
                const wrapper = document.createElement("div");
                const label = document.createElement("label");

                const select = document.createElement("select");
                select.id = "field_" + this.instanceId;

                this.options.forEach(optionText => {
                    const option = document.createElement("option");
                    option.value = optionText;
                    option.textContent = optionText;
                    select.appendChild(option);
                });

                wrapper.appendChild(label);
                wrapper.appendChild(select);
                this.bodyEl.appendChild(wrapper);
            }
        }

        class DateFormField extends BaseFormField{
            constructor(config) {
                super(config);
                this.createDateInput();
            }

            createDateInput() {
                const wrapper = document.createElement("div");
                const label = document.createElement("label");

                const input = document.createElement("input");
                input.type = "date";
                input.id = "field_" + this.instanceId;

                wrapper.appendChild(label);
                wrapper.appendChild(input);
                this.bodyEl.appendChild(wrapper);
            }
        }

        class InfoFormField extends BaseFormField{
            constructor(config) {
                super(config);
                this.value = config.value || "";
                this.createInfoText();
            }

            createInfoText(){
                const wrapper = document.createElement("div");
                const text = document.createElement("p");
                text.textContent = this.value;
                text.style.margin = "0";
                text.style.fontSize = "14px";

                wrapper.appendChild(text);
                this.bodyEl.appendChild(wrapper);
            }
        }

        class PictureFormField extends BaseFormField{
            constructor(config) {
                super(config);
                this.src = config.src || "";
                this.createPicture();
            }

            createPicture(){
                const wrapper = document.createElement("div");
                if (this.src) {
                    const img = document.createElement("img");
                    img.src = this.src;
                    img.alt = this.title;
                    img.style.maxWidth = "100%";
                    img.style.maxHeight = "400px";
                    img.style.width = "auto";
                    img.style.margin = "8px auto";
                    img.style.display = "block";
                    img.style.height = "auto";
                    img.style.display = "block";
                    img.style.marginTop = "8px";
                    img.style.border = "1px solid #ccc";
                    img.style.borderRadius = "4px";
                    wrapper.appendChild(img);
                }
                this.bodyEl.appendChild(wrapper);
            }
        }

        class FileFormField extends BaseFormField{
            constructor(config) {
                super(config);
                this.createFileInput();
            }

            createFileInput() {
                const wrapper = document.createElement("div");
                const label = document.createElement("label");

                const input = document.createElement("input");
                input.type = "file";
                input.id = "field_" + this.instanceId;

                wrapper.appendChild(label);
                wrapper.appendChild(input);
                this.bodyEl.appendChild(wrapper);
            }
        }

        class NumberFormField extends BaseFormField{
            constructor(config) {
                super(config);
                this.createNumberInput();
            }

            createNumberInput() {
                const wrapper = document.createElement("div");
                const label = document.createElement("label");

                const input = document.createElement("input");
                input.type = "number";
                input.id = "field_" + this.instanceId;

                wrapper.appendChild(label);
                wrapper.appendChild(input);
                this.bodyEl.appendChild(wrapper);
            }
        }

        class RadioMultipleChoiceFormField extends BaseFormField{
            constructor(config){
                super(config);
                this.options = config.options || [];
                this.allowMultiple = config.allowMultiple || false;
                this.createOptionsInput();
            }

            createOptionsInput() {
                const wrapper = document.createElement("div");
                const label = document.createElement("label");
                wrapper.appendChild(label);

                let selectedRadio = null;

                this.options.forEach((optionText, index) => {
                    const optionWrapper = document.createElement("div");
                    optionWrapper.style.marginTop = "8px";

                    const optionLabel = document.createElement("label");
                    optionLabel.htmlFor = "field_" + this.instanceId + "_" + index;
                    optionLabel.textContent = optionText;
                    optionLabel.style.marginLeft = "8px";
                    optionLabel.style.fontWeight = "normal";

                    const input = document.createElement("input");
                    if(this.allowMultiple){
                        input.type = "checkbox";
                    }else{
                        input.type = "radio";
                        input.name = "radio_group_" + this.instanceId; // Alle Radios derselben Gruppe

                        // Abwählen-Funktionalität für Radio-Buttons
                        input.addEventListener('click', function(e) {
                            if (selectedRadio === this) {
                                // Wenn bereits ausgewählt, abwählen
                                this.checked = false;
                                selectedRadio = null;
                            } else {
                                // Neues Radio auswählen
                                selectedRadio = this;
                            }
                        });
                    }
                    input.id = "field_" + this.instanceId + "_" + index;
                    input.name = "field_" + this.instanceId

                    input.value = optionText;
                    optionWrapper.appendChild(input);
                    optionWrapper.appendChild(optionLabel);
                    wrapper.appendChild(optionWrapper);
                });

                this.bodyEl.appendChild(wrapper);
            }
        }

        // Render nach DOM-Load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => renderForm(specs));
        } else {
            renderForm(specs);
        }
    <` + `/script>
</body>
</html>`;
    }
</script>
</body>
</html>
