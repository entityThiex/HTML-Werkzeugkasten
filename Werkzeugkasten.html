<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Form Builder</title>
  <style>
    body { font-family: Arial, sans-serif; height: 100vh; margin: 0; overflow: hidden; }
    #form-builder { position: relative; width: 100%; height: 100%; background: #f0f0f0; }
    .field { position: absolute; top: 50px; left: 50px; width: 360px; background: #fff; 
             border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); box-sizing: border-box; }
    .field-header { cursor: move; background: #007bff; color: #fff; padding: 8px 10px; display: flex; 
                    align-items: center; justify-content: space-between; border-radius: 6px 6px 0 0; }
    .field-title { font-size: 14px; font-weight: bold; position: relative; }
    .field-title[data-info]:hover::after { content: attr(data-info); position: absolute; left: 0; top: 130%; 
                                           background: #333; color: #fff; padding: 6px 8px; border-radius: 4px; 
                                           font-size: 12px; white-space: nowrap; z-index: 10; }
    .field-required { display: flex; align-items: center; gap: 4px; font-size: 12px; }
    .field-body { padding: 8px 10px 10px; }
    .field-required-indicator { color: #ffeb3b; margin-left: 4px; font-size: 14px; }
    .field-config { margin-bottom: 8px; padding: 6px; background: #f5f5f5; border-radius: 4px; 
                    border: 1px solid #ddd; font-size: 12px; }
    .field-config label { display: block; margin-bottom: 3px; font-weight: bold; }
    .field-config input[type="text"], .field-config textarea { width: 100%; box-sizing: border-box; 
                                                                font-size: 12px; padding: 4px; border-radius: 3px; 
                                                                border: 1px solid #ccc; margin-bottom: 6px; resize: vertical; }
  </style>
</head>
<body>
  <div id="form-builder"></div>
  <script>
    class BaseField {
      static instanceCounter = 0;

      constructor(options) {
        this.instanceId = ++BaseField.instanceCounter;
        this.type = options.type || "base";
        this.title = options.title || "";
        this.infoText = options.infoText || "";
        this.required = !!options.required;
        this.x = options.x || 50;
        this.y = options.y || 50;
        this.createDOM();
        this.initDrag();
        this.initRequiredCheckbox();
        this.initConfigUI();
      }

      createDOM() {
        this.el = this.createElement("div", "field");
        Object.assign(this.el.style, { left: this.x + "px", top: this.y + "px" });

        const header = this.createElement("div", "field-header");
        this.titleEl = this.createElement("span", "field-title", "Feld");
        if (this.infoText) this.titleEl.setAttribute("data-info", this.infoText);

        const rightHeader = this.createElement("div", "field-required");
        this.requiredCheckbox = this.createInput("checkbox", this.required);
        const cbLabel = this.createElement("span", null, "Pflicht");
        this.requiredIndicator = this.createElement("span", "field-required-indicator", this.required ? "*" : "");

        rightHeader.append(this.requiredCheckbox, cbLabel, this.requiredIndicator);
        header.append(this.titleEl, rightHeader);

        this.bodyEl = this.createElement("div", "field-body");
        this.el.append(header, this.bodyEl);
        document.getElementById("form-builder").appendChild(this.el);
      }

      createElement(tag, className, text) {
        const el = document.createElement(tag);
        if (className) el.className = className;
        if (text) el.textContent = text;
        return el;
      }

      createInput(type, value) {
        const input = document.createElement("input");
        input.type = type;
        if (type === "checkbox") input.checked = value;
        else if (value) input.value = value;
        return input;
      }

      initRequiredCheckbox() {
        this.requiredCheckbox.addEventListener("change", () => {
          this.required = this.requiredCheckbox.checked;
          this.requiredIndicator.textContent = this.required ? "*" : "";
        });
      }

      initConfigUI() {
        const config = this.createElement("div", "field-config");
        const titleLabel = this.createElement("label", null, "Titel");
        const titleInput = this.createInput("text", this.title);
        titleInput.addEventListener("input", () => this.title = titleInput.value);

        const infoLabel = this.createElement("label", null, "Zusatzinfo");
        const infoInput = document.createElement("textarea");
        infoInput.rows = 2;
        infoInput.value = this.infoText;
        infoInput.addEventListener("input", () => {
          this.infoText = infoInput.value;
          this.infoText.trim() ? this.titleEl.setAttribute("data-info", this.infoText) : this.titleEl.removeAttribute("data-info");
        });

        config.append(titleLabel, titleInput, infoLabel, infoInput);
        this.bodyEl.appendChild(config);
      }

      initDrag() {
        const header = this.el.querySelector(".field-header");
        let offsetX = 0, offsetY = 0, isDragging = false;

        const onMouseMove = (e) => {
          if (!isDragging) return;
          const parentRect = this.el.parentElement.getBoundingClientRect();
          let x = Math.max(0, Math.min(parentRect.width - this.el.offsetWidth, e.clientX - parentRect.left - offsetX));
          let y = Math.max(0, Math.min(parentRect.height - this.el.offsetHeight, e.clientY - parentRect.top - offsetY));
          Object.assign(this.el.style, { left: x + "px", top: y + "px" });
        };

        const onMouseUp = () => {
          isDragging = false;
          document.removeEventListener("mousemove", onMouseMove);
          document.removeEventListener("mouseup", onMouseUp);
        };

        header.addEventListener("mousedown", (e) => {
          isDragging = true;
          const rect = this.el.getBoundingClientRect();
          offsetX = e.clientX - rect.left;
          offsetY = e.clientY - rect.top;
          document.addEventListener("mousemove", onMouseMove);
          document.addEventListener("mouseup", onMouseUp);
        });
      }

      toConfigObject() {
        const rect = this.el.getBoundingClientRect();
        const parentRect = this.el.parentElement.getBoundingClientRect();
        return {
          type: this.type, title: this.title, infoText: this.infoText, required: this.required,
          x: rect.left - parentRect.left, y: rect.top - parentRect.top
        };
      }

      createLabeledInput(labelText, inputType, extra = {}) {
        const wrapper = document.createElement("div");
        const label = this.createElement("label", null, labelText);
        Object.assign(label.style, { display: "block", marginBottom: "4px", fontSize: "12px" });
        
        const input = document.createElement(inputType === "textarea" ? "textarea" : "input");
        if (inputType !== "textarea") input.type = inputType;
        Object.assign(input.style, { width: "100%", boxSizing: "border-box" });
        Object.assign(input, extra);
        
        wrapper.append(label, input);
        this.bodyEl.appendChild(wrapper);
        return input;
      }
    }

    class Textfield extends BaseField {
      constructor(options) {
        super({ ...options, type: "text" });
        this.createLabeledInput("Text", "text");
        this.titleEl.textContent = "Textfeld";
      }
    }

    class DateField extends BaseField {
      constructor(options) {
        super({ ...options, type: "date" });
        this.createLabeledInput("Datum Feld", "date");
        this.titleEl.textContent = "Datumsfeld";
      }
    }

    class NumberField extends BaseField {
      constructor(options) {
        super({ ...options, type: "number" });
        this.createLabeledInput("Nummer Feld", "number");
        this.titleEl.textContent = "Zahlenfeld";
      }
    }

    class InfoField extends BaseField {
      constructor(options) {
        super({ ...options, type: "info", required: false });
        this.inputEl = this.createLabeledInput("Info Feld", "textarea", { rows: 2 });
        this.titleEl.textContent = "Infofeld";
      }

      toConfigObject() {
        return { ...super.toConfigObject(), content: this.inputEl.value };
      }
    }

    class PictureField extends BaseField {
      constructor(options) {
        super({ ...options, type: "picture" });
        this.createLabeledInput("Bild Feld", "file", { accept: "image/*" });
        this.titleEl.textContent = "Bildfeld";
      }
    }

    class DropDownfield extends BaseField {
      constructor(options) {
        super({ ...options, type: "dropdown" });
        this.options = [];
        this.createSelectInput();
        this.titleEl.textContent = "Dropdown-Feld";
      }

      createSelectInput() {
        const wrapper = document.createElement("div");
        const label = this.createElement("label", null, "Optionen");
        Object.assign(label.style, { display: "block", marginBottom: "4px", fontSize: "12px" });

        const { input, button, container } = this.createInputRow("Neue Option eingeben", "Hinzufügen");
        this.optionsContainer = document.createElement("div");
        Object.assign(this.optionsContainer.style, { maxHeight: "150px", overflowY: "auto", padding: "4px" });

        const addOption = () => {
          if (input.value.trim()) {
            this.addOption(input.value.trim());
            input.value = "";
          }
        };

        button.addEventListener("click", addOption);
        input.addEventListener("keypress", (e) => e.key === "Enter" && addOption());

        wrapper.append(label, container, this.optionsContainer);
        this.bodyEl.appendChild(wrapper);
      }

      createInputRow(placeholder, buttonText) {
        const container = document.createElement("div");
        Object.assign(container.style, { display: "flex", marginBottom: "10px", gap: "5px" });
        
        const input = this.createInput("text");
        input.style.flex = "1";
        input.placeholder = placeholder;
        
        const button = this.createElement("button", null, buttonText);
        button.style.padding = "4px 8px";
        
        container.append(input, button);
        return { input, button, container };
      }

      addOption(text) {
        const optionDiv = document.createElement("div");
        Object.assign(optionDiv.style, {
          display: "flex", justifyContent: "space-between", alignItems: "center",
          padding: "4px", marginBottom: "4px", backgroundColor: "#f5f5f5",
          borderRadius: "4px", cursor: "move"
        });
        optionDiv.draggable = true;

        const optionText = this.createElement("span", null, text);
        Object.assign(optionText.style, { fontSize: "12px", pointerEvents: "none" });

        const deleteButton = this.createDeleteButton(() => {
          optionDiv.remove();
          this.updateOptions();
        });

        this.addDragListeners(optionDiv);
        optionDiv.append(optionText, deleteButton);
        this.optionsContainer.appendChild(optionDiv);
        this.updateOptions();
      }

      createDeleteButton(onClick) {
        const button = this.createElement("button", null, "×");
        Object.assign(button.style, {
          padding: "2px 6px", backgroundColor: "#ff4444", color: "white",
          border: "none", borderRadius: "3px", cursor: "pointer"
        });
        button.addEventListener("click", onClick);
        return button;
      }

      addDragListeners(el) {
        const setBorder = (show) => el.style.borderTop = show ? "2px solid #007bff" : "none";

        el.addEventListener('dragstart', () => { el.classList.add('dragging'); el.style.opacity = '0.5'; });
        el.addEventListener('dragend', () => { el.classList.remove('dragging'); el.style.opacity = '1'; this.updateOptions(); });
        el.addEventListener('dragover', (e) => {
          e.preventDefault();
          const dragging = this.optionsContainer.querySelector('.dragging');
          const siblings = [...this.optionsContainer.querySelectorAll('div:not(.dragging)')];
          const next = siblings.find(s => e.clientY - s.getBoundingClientRect().top - s.offsetHeight / 2 < 0);
          this.optionsContainer.insertBefore(dragging, next || null);
        });
        el.addEventListener('dragenter', (e) => { e.preventDefault(); setBorder(true); });
        el.addEventListener('dragleave', (e) => { e.preventDefault(); setBorder(false); });
        el.addEventListener('drop', (e) => { e.preventDefault(); setBorder(false); });
      }

      updateOptions() {
        this.options = Array.from(this.optionsContainer.querySelectorAll("span")).map(s => s.textContent);
      }

      toConfigObject() {
        return { ...super.toConfigObject(), options: this.options };
      }
    }

    class Radio_MultipleChoicefield extends BaseField {
      constructor(options) {
        super({ ...options, type: "radio_multiple" });
        this.options = [];
        this.allowMultiple = false;
        this.createOptionsInput();
        this.titleEl.textContent = "Radio-/Multiple-Choice-Feld";
      }

      createOptionsInput() {
        const wrapper = document.createElement("div");
        
        const multipleChoice = this.createCheckbox("Mehrfachauswahl erlauben", this.allowMultiple, (checked) => {
          this.allowMultiple = checked;
          this.updateOptionsPreview();
        });
        
        const label = this.createElement("label", null, "Auswahlmöglichkeiten");
        Object.assign(label.style, { display: "block", marginBottom: "4px", fontSize: "12px" });

        const { input, button, container } = this.createInputRow("Neue Auswahlmöglichkeit eingeben", "Hinzufügen");
        this.optionsContainer = document.createElement("div");
        Object.assign(this.optionsContainer.style, { maxHeight: "150px", overflowY: "auto", padding: "4px" });

        const addOption = () => {
          if (input.value.trim()) {
            this.addOption(input.value.trim());
            input.value = "";
          }
        };

        button.addEventListener("click", addOption);
        input.addEventListener("keypress", (e) => e.key === "Enter" && addOption());

        wrapper.append(multipleChoice, label, container, this.optionsContainer);
        this.bodyEl.appendChild(wrapper);
      }

      createCheckbox(text, checked, onChange) {
        const container = document.createElement("div");
        container.style.marginBottom = "10px";
        
        const cb = this.createInput("checkbox", checked);
        cb.id = "multipleChoice_" + this.instanceId;
        cb.addEventListener("change", () => onChange(cb.checked));
        
        const label = this.createElement("label", null, text);
        label.htmlFor = cb.id;
        Object.assign(label.style, { fontSize: "12px", marginLeft: "5px" });
        
        container.append(cb, label);
        return container;
      }

      createInputRow(placeholder, buttonText) {
        const container = document.createElement("div");
        Object.assign(container.style, { display: "flex", marginBottom: "10px", gap: "5px" });
        
        const input = this.createInput("text");
        input.style.flex = "1";
        input.placeholder = placeholder;
        
        const button = this.createElement("button", null, buttonText);
        button.style.padding = "4px 8px";
        
        container.append(input, button);
        return { input, button, container };
      }

      addOption(text) {
        const optionDiv = document.createElement("div");
        Object.assign(optionDiv.style, {
          display: "flex", justifyContent: "space-between", alignItems: "center",
          padding: "4px", marginBottom: "4px", backgroundColor: "#f5f5f5",
          borderRadius: "4px", cursor: "move"
        });
        optionDiv.draggable = true;

        const inputPreview = this.createInput(this.allowMultiple ? "checkbox" : "radio");
        inputPreview.name = "preview_" + this.instanceId;
        Object.assign(inputPreview.style, { marginRight: "8px", cursor: "default" });
        inputPreview.onclick = (e) => e.preventDefault();

        const optionText = this.createElement("span", null, text);
        Object.assign(optionText.style, { fontSize: "12px", flex: "1", pointerEvents: "none" });

        const deleteButton = this.createDeleteButton(() => {
          optionDiv.remove();
          this.updateOptions();
        });

        const textContainer = document.createElement("div");
        Object.assign(textContainer.style, { display: "flex", alignItems: "center", flex: "1" });
        textContainer.append(inputPreview, optionText);

        this.addDragListeners(optionDiv);
        optionDiv.append(textContainer, deleteButton);
        this.optionsContainer.appendChild(optionDiv);
        this.updateOptions();
      }

      createDeleteButton(onClick) {
        const button = this.createElement("button", null, "×");
        Object.assign(button.style, {
          padding: "2px 6px", backgroundColor: "#ff4444", color: "white",
          border: "none", borderRadius: "3px", cursor: "pointer", marginLeft: "8px"
        });
        button.addEventListener("click", onClick);
        return button;
      }

      addDragListeners(el) {
        const setBorder = (show) => el.style.borderTop = show ? "2px solid #007bff" : "none";

        el.addEventListener('dragstart', () => { el.classList.add('dragging'); el.style.opacity = '0.5'; });
        el.addEventListener('dragend', () => { el.classList.remove('dragging'); el.style.opacity = '1'; this.updateOptions(); });
        el.addEventListener('dragover', (e) => {
          e.preventDefault();
          const dragging = this.optionsContainer.querySelector('.dragging');
          const siblings = [...this.optionsContainer.querySelectorAll('div:not(.dragging)')];
          const next = siblings.find(s => e.clientY - s.getBoundingClientRect().top - s.offsetHeight / 2 < 0);
          this.optionsContainer.insertBefore(dragging, next || null);
        });
        el.addEventListener('dragenter', (e) => { e.preventDefault(); setBorder(true); });
        el.addEventListener('dragleave', (e) => { e.preventDefault(); setBorder(false); });
        el.addEventListener('drop', (e) => { e.preventDefault(); setBorder(false); });
      }

      updateOptionsPreview() {
        this.optionsContainer.querySelectorAll('input').forEach(input => {
          input.type = this.allowMultiple ? "checkbox" : "radio";
        });
      }

      updateOptions() {
        this.options = Array.from(this.optionsContainer.querySelectorAll("span")).map(s => s.textContent);
      }

      toConfigObject() {
        return { ...super.toConfigObject(), options: this.options, allowMultiple: this.allowMultiple };
      }
    }

    </script>
</body>
</html>
