<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Oberklasse-Feld (Basisversion)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }

    #form-builder {
      position: relative;
      width: 100%;
      height: 100%;
      background: #f0f0f0;
    }

    .field {
      position: absolute;
      top: 50px;
      left: 50px;
      width: 360px;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    .field-header {
      cursor: move;
      background: #007bff;
      color: #fff;
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 6px 6px 0 0;
    }

    .field-title {
      font-size: 14px;
      font-weight: bold;
      position: relative;
    }

    /* Tooltip */
    .field-title[data-info]:hover::after {
      content: attr(data-info);
      position: absolute;
      left: 0;
      top: 130%;
      background: #333;
      color: #fff;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 10;
    }

    .field-required {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }

    .field-body {
      padding: 8px 10px 10px;
    }

    .field-required-indicator {
      color: #ffeb3b;
      margin-left: 4px;
      font-size: 14px;
    }

    /* Konfiguration (Titel & Zusatzinfo) */
    .field-config {
      margin-bottom: 8px;
      padding: 6px;
      background: #f5f5f5;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 12px;
    }

    .field-config label {
      display: block;
      margin-bottom: 3px;
      font-weight: bold;
    }

    .field-config input[type="text"],
    .field-config textarea {
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
      padding: 4px;
      border-radius: 3px;
      border: 1px solid #ccc;
      margin-bottom: 6px;
      resize: vertical;
    }
  </style>
</head>
<body>
  <div id="form-builder"></div>
  <script>
    // ===== Oberklasse: BaseField =====
    class BaseField {
      static instanceCounter = 0;  // Statische Variable für alle Instanzen

      constructor(options) {
        BaseField.instanceCounter++;  // Erhöhe Zähler bei jeder neuen Instanz
        this.instanceId = BaseField.instanceCounter;  // Speichere aktuelle Nummer in der Instanz
        
        this.type = options.type || "base";         
        this.title = options.title || "Feld";       // intern gespeichert
        this.infoText = options.infoText || "";     
        this.required = !!options.required;
        this.x = options.x || 50;
        this.y = options.y || 50;

        this.createDOM();
        this.initDrag();
        this.initRequiredCheckbox();
        this.initConfigUI(); // Titel + Zusatzinfo editierbar
      }

      createDOM() {
        const container = document.getElementById("form-builder");

        this.el = document.createElement("div");
        this.el.className = "field";
        this.el.style.left = this.x + "px";
        this.el.style.top = this.y + "px";

        // Header
        const header = document.createElement("div");
        header.className = "field-header";

        const titleSpan = document.createElement("span");
        titleSpan.className = "field-title";
        titleSpan.textContent = "Feld"; // Anzeige bleibt immer gleich
        if (this.infoText) {
          titleSpan.setAttribute("data-info", this.infoText);
        }
        this.titleEl = titleSpan;

        const rightHeader = document.createElement("div");
        rightHeader.className = "field-required";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = this.required;
        this.requiredCheckbox = cb;

        const cbLabel = document.createElement("span");
        cbLabel.textContent = "Pflicht";

        const reqIndicator = document.createElement("span");
        reqIndicator.className = "field-required-indicator";
        reqIndicator.textContent = this.required ? "*" : "";
        this.requiredIndicator = reqIndicator;

        rightHeader.appendChild(cb);
        rightHeader.appendChild(cbLabel);
        rightHeader.appendChild(reqIndicator);

        header.appendChild(titleSpan);
        header.appendChild(rightHeader);

        const body = document.createElement("div");
        body.className = "field-body";
        this.bodyEl = body;

        this.el.appendChild(header);
        this.el.appendChild(body);
        container.appendChild(this.el);
      }

      initRequiredCheckbox() {
        this.requiredCheckbox.addEventListener("change", () => {
          this.required = this.requiredCheckbox.checked;
          this.requiredIndicator.textContent = this.required ? "*" : "";
        });
      }

      // Titel + Zusatzinfo editierbar (intern gespeichert)
      initConfigUI() {
        const config = document.createElement("div");
        config.className = "field-config";

        // Titel (intern gespeichert, nicht sichtbar im Header)
        const titleLabel = document.createElement("label");
        titleLabel.textContent = "Titel (wird später im fertigen HTML angezeigt):";

        const titleInput = document.createElement("input");
        titleInput.type = "text";
        titleInput.value = this.title;

        titleInput.addEventListener("input", () => {
          this.title = titleInput.value;
        });

        // Zusatzinfo (Tooltip)
        const infoLabel = document.createElement("label");
        infoLabel.textContent = "Zusatzinfo (Tooltip beim Hover über dem Titel):";

        const infoInput = document.createElement("textarea");
        infoInput.rows = 2;
        infoInput.value = this.infoText;

        infoInput.addEventListener("input", () => {
          this.infoText = infoInput.value;
          if (this.infoText.trim()) {
            this.titleEl.setAttribute("data-info", this.infoText);
          } else {
            this.titleEl.removeAttribute("data-info");
          }
        });

        config.appendChild(titleLabel);
        config.appendChild(titleInput);
        config.appendChild(infoLabel);
        config.appendChild(infoInput);

        this.bodyEl.appendChild(config);
      }

      initDrag() {
        const header = this.el.querySelector(".field-header");
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;

        header.addEventListener("mousedown", (e) => {
          isDragging = true;
          const rect = this.el.getBoundingClientRect();
          offsetX = e.clientX - rect.left;
          offsetY = e.clientY - rect.top;

          document.addEventListener("mousemove", onMouseMove);
          document.addEventListener("mouseup", onMouseUp);
        });

        const onMouseMove = (e) => {
          if (!isDragging) return;
          const parentRect = this.el.parentElement.getBoundingClientRect();
          let x = e.clientX - parentRect.left - offsetX;
          let y = e.clientY - parentRect.top - offsetY;

          // Begrenzung im Container
          x = Math.max(0, Math.min(parentRect.width - this.el.offsetWidth, x));
          y = Math.max(0, Math.min(parentRect.height - this.el.offsetHeight, y));

          this.el.style.left = x + "px";
          this.el.style.top = y + "px";
        };

        const onMouseUp = () => {
          isDragging = false;
          document.removeEventListener("mousemove", onMouseMove);
          document.removeEventListener("mouseup", onMouseUp);
        };
      }

      // Für spätere HTML-Erzeugung vorbereiten
      toConfigObject() {
        const rect = this.el.getBoundingClientRect();
        const parentRect = this.el.parentElement.getBoundingClientRect();
        return {
          type: this.type,
          title: this.title,         // gespeicherter individueller Titel
          infoText: this.infoText,   // gespeicherter Tooltip
          required: this.required,
          x: rect.left - parentRect.left,
          y: rect.top - parentRect.top
        };
      }
    }
    // Hinweis: toConfigObject() liefert später alle wichtigen Daten für HTML-Generierung
  </script>


  <button onclick="downloadBuilder()">Aktuellen Stand Speichern</button>
  <button onclick="exportBuilder()">Aktuellen Stand Exportieren</button>
  <script>
    function downloadBuilder(){
      let jsonLink = document.createElement('a');
      jsonLink.href = URL.createObjectURL(getSpecsBlob());
      jsonLink.download = 'specs.json';
      jsonLink.click();
    }

    function exportBuilder(){
      let formLink = document.createElement('a');
      formLink.href = URL.createObjectURL(getFormBlob());
      formLink.download = 'form.html';
      formLink.click();

      let evalLink = document.createElement('a');
      evalLink.href = URL.createObjectURL(getEvalBlob());
      evalLink.download = 'eval.html';
      evalLink.click();
    }

    let specs = {
      "form": {
        "fields": [],
        "scripts": []
      },
      "eval": {
        "fields": [],
        "scripts": []
      }
    }

    let defaultSpecs = {
      "form": {
        "fields": [],
        "scripts": []
      },
      "eval": {
        "fields": [],
        "scripts": []
      }
    }


    function createFormFromJson(){
      return createHTMLFromJson("form");
    }

    function createEvalFromJson(){
      return createHTMLFromJson("eval");
    }

    function createHTMLFromJson(type){
      let fields = defaultSpecs[type]["fields"].concat(specs[type]["fields"]);
      let html = new HtmlObj();
      fields.forEach(html.append());

      let scripts = defaultSpecs[type]["scripts"].concat(specs[type]["scripts"]);
      scripts.forEach(html.append());

      return html.finish();
    }

    function getSpecsBlob(){
      let jsonSpecs = new JsonObj(specs);
      return jsonSpecs.getDownloadFile();
    }

    function getFormBlob(){
      let htmlForm = createFormFromJson();
      return htmlForm.getDownloadFile();
    }

    function getEvalBlob(){
      let htmlEval = createEvalFromJson();
      return htmlEval.getDownloadFile();
    }

    function createZip(json, files){

    }

    function loadFile(){

    }

    class Obj{
      constructor() {

      }

      getDownloadFile(data, type){ // TODO if there is a better option
        return new Blob([data], {type: ''});
      }

      getContent(){}
    }

    class HtmlObj extends Obj{
      fullHtml = "";
      htmlHeader = "<header>";
      htmlBody = "<body>";
      htmlFooter = "<footer>";

      constructor(html = "<!DOCTYPE html><html lang=\"de\">"){
        super();
        this.fullHtml = html;
      }

      append(jsonHtml){
        if(jsonHtml instanceof JSON && jsonHtml.has("html")){
          if (jsonHtml.has("type") && jsonHtml["type"] === "header"){
            this.htmlHeader += jsonHtml["html"];
          }
          else if (jsonHtml.has("type") && jsonHtml["type"] === "body") {
            this.htmlBody += jsonHtml["html"];
          }
          else if (jsonHtml.has("type") && jsonHtml["type"] === "footer") {
            this.htmlFooter += jsonHtml["html"];
          }
        }
        return this;
      }

      finish(){
        this.htmlHeader += "</header>";
        this.htmlBody += "</body>";
        this.htmlFooter += "</footer>";
        this.fullHtml += this.htmlHeader+this.htmlBody+this.htmlFooter+"</html>";
        return this;
      }

      getDownloadFile() {
        super.getDownloadFile(this.fullHtml, 'text/html');
      }

      getContent() {
        return this.fullHtml;
      }
    }

    class JsonObj extends Obj{
      json = {}
      constructor(json) {
        super();
        this.json = json;
      }

      getDownloadFile() {
        super.getDownloadFile(this.json, 'application/json');
      }

      getContent() {
        return this.json;
      }
    }
  </script>
</body>
</html>
