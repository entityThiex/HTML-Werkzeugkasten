<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Oberklasse-Feld (Basisversion)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }

    #form-builder {
      position: relative;
      margin: 0 auto;
      width: 50%;
      height: 100%;
      background: #f0f0f0;
    }

    .field {
      position: absolute;
      top: 50px;
      left: 50px;
      width: 100%;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    .field-header {
      cursor: move;
      background: #007bff;
      color: #fff;
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 6px 6px 0 0;
    }

    .field-title {
      font-size: 14px;
      font-weight: bold;
      position: relative;
    }

    /* Tooltip */
    .field-title[data-info]:hover::after {
      content: attr(data-info);
      position: absolute;
      left: 0;
      top: 130%;
      background: #333;
      color: #fff;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 10;
    }

    .field-required {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }

    .field-body {
      padding: 8px 10px 10px;
    }

    .field-required-indicator {
      color: #ffeb3b;
      margin-left: 4px;
      font-size: 14px;
    }

    /* Konfiguration (Titel & Zusatzinfo) */
    .field-config {
      margin-bottom: 8px;
      padding: 6px;
      background: #f5f5f5;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 12px;
    }

    .field-config label {
      display: block;
      margin-bottom: 3px;
      font-weight: bold;
    }

    .field-config input[type="text"],
    .field-config textarea {
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
      padding: 4px;
      border-radius: 3px;
      border: 1px solid #ccc;
      margin-bottom: 6px;
      resize: vertical;
    }

    .dropbtn {
        background-color: #04AA6D;
        color: white;
        padding: 16px;
        font-size: 16px;
        border: none;
    }

    .dropdown {
        position: relative;
        top: 0;
        left: 0;
        display: inline-block;
    }
    .dropdown-content {
        display: none;
        position: fixed;
        background-color: #f1f1f1;
        min-width: 160px;
        box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
        z-index: 2;
    }

    .dropdown-content button {
        color: black;
        width: 100%;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }

    /* Change color of dropdown links on hover */
    .dropdown-content button:hover {background-color: #ddd;}

    /* Show the dropdown menu on hover */
    .dropdown:hover .dropdown-content {display: block;}

    /* Change the background color of the dropdown button when the dropdown content is shown */
    .dropdown:hover .dropbtn {background-color: #3e8e41;}

    .topmenu {
        height: 50px;
        width: 100%;
        position: sticky;
        top: 0;
        overflow-y: visible;
        z-index: 1;
    }

    .page {
        overflow-y: auto;
        position: absolute;
        top: 50px;
        bottom: 50px;
        width: 100%;
    }

    .spacer {
        bottom: 0;
        margin: 0 auto;
        position: absolute;
        height: 50px;
        width: 100%;
    }

    .btn {
        background-color: #04AA6D;
        color: white;
        padding: 16px;
        font-size: 16px;
        border: none;
    }

    .title {
        padding: 15px;
        font-size: 16px;
    }

    .rightMenu {
        width: 25%;
        top: 0;
        right: 0;
        position: absolute;
        height: 50px;
        display: inline-block;
    }

    .disapear {
        display: none;
    }
  </style>
</head>
<body>


    <div class="topmenu">
      <div class="dropdown">
          <button class="dropbtn">Hinzufügen</button>
          <div class="dropdown-content">
              <button onclick="addTextField()">Text</button>
              <button onclick="addInfoField()">Info</button>
              <button onclick="addNumberField()">Zahlen</button>
              <button onclick="addDateField()">Datum</button>
              <button onclick="addPictureField()">Bild</button>
              <button onclick="addFileField()">Datei</button>
              <button onclick="addDropdownField()">Dropdown</button>
              <button onclick="addMultipleChoiceField()">Mehrfachauswahl</button>
          </div>
      </div>

      <div class="dropdown">
          <button class="dropbtn">Export</button>
          <div class="dropdown-content">
              <button id="saveBtn">Speichern</button>
              <button id="exportBtn">Exportieren</button>
          </div>
      </div>

      <label for="importFile" class="btn">Import</label>
      <input id="importFile" type="file" accept="*/*" class="disapear">

      <div class="rightMenu">
          <label>
              <input type="text" placeholder="Titel" id="titel" class="title">
          </label>
          <label for="logo" class="btn">Logo wählen</label>
          <input type="file" accept="image/*" id="logo" class="disapear">

      </div>
    </div>

    <div class="spacer"></div>


    <div class="page">
      <div id="form-builder"></div>
    </div>

  <script>
    // ===== Oberklasse: BaseField =====
    class BaseField {
      constructor(options) {
          // Erhöhe Zähler bei jeder neuen Instanz
          this.instanceId = options.id || specs["vars"]["id-counter"]++;  // Speichere aktuelle Nummer in der Instanz

          this.type = options.type || "base";
        this.title = options.title || "";       // intern gespeichert
        this.infoText = options.infoText || "";     
        this.required = !!options.required;
        this.x = options.x || 0;
        this.y = options.y || 0;

        this.createDOM();
        this.initDrag();
        this.initRequiredCheckbox();
        this.initConfigUI(); // Titel + Zusatzinfo editierbar

          insertField(this);
      }

      createDOM() {
        const container = document.getElementById("form-builder");

        this.el = document.createElement("div");
        this.el.className = "field"; //weißt eine CSS-Klasse für Styling zu
        this.el.style.left = this.x + "px"; //Position X
        this.el.style.top = this.y + "px"; //Position Y
        this.el.id = String(this.instanceId)

        // Header
        const header = document.createElement("div");
        header.className = "field-header";

        const titleSpan = document.createElement("span");
        titleSpan.className = "field-title";
        titleSpan.textContent = "Feld"; // Anzeige bleibt immer gleich
        if (this.infoText) {
          titleSpan.setAttribute("data-info", this.infoText);
        }
        this.titleEl = titleSpan;

      const btnUp = document.createElement("button");
      btnUp.className = "move-btn";
      btnUp.textContent = "^"
      const field = this.el;
      const parent = this
      btnUp.onclick = function () {
          console.log(field);
          container.insertBefore(field, field.previousElementSibling);
          if(field.previousElementSibling === null){
              moveField(field.id, 0);
          }
          else {
              moveField(field.id, getFieldPos(field.previousElementSibling.id));
          }
          parent.repositionAllFields();
      };

      const btnDown = document.createElement("button");
      btnDown.className = "move-btn";
      btnDown.textContent = "v"
      btnDown.onclick = function () {
          console.log(field);
          container.insertBefore(field.nextElementSibling, field);
          if(field.nextElementSibling === null){
              moveField(field.id);
          }
          else{
              moveField(field.nextElementSibling.id, getFieldPos(field.id));
          }
          parent.repositionAllFields();
      }

        const rightHeader = document.createElement("div");
        rightHeader.className = "field-required";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = this.required;
        this.requiredCheckbox = cb;

        const cbLabel = document.createElement("span");
        cbLabel.textContent = "Pflicht"; //Text für Label

        const reqIndicator = document.createElement("span");
        reqIndicator.className = "field-required-indicator";
        reqIndicator.textContent = this.required ? "*" : "";
        this.requiredIndicator = reqIndicator;

        // Delete Button hinzufügen
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "×";
        deleteBtn.style.marginLeft = "10px";
        deleteBtn.style.padding = "2px 8px";
        deleteBtn.style.backgroundColor = "#ff4444";
        deleteBtn.style.color = "white";
        deleteBtn.style.border = "none";
        deleteBtn.style.borderRadius = "3px";
        deleteBtn.style.cursor = "pointer";
        deleteBtn.style.fontSize = "16px";
        deleteBtn.style.fontWeight = "bold";

        deleteBtn.addEventListener("click", () => {
          this.el.remove();
          // Repositioniere alle verbleibenden Felder nach dem Löschen
          setTimeout(() => {
            const container = document.getElementById("form-builder");
            const allFields = container.querySelectorAll(".field");
            let currentY = 0;

            allFields.forEach(field => {
              field.style.left = "0px";
              field.style.top = currentY + "px";
              currentY += field.offsetHeight + 10;
            });
          }, 0);
            removeField(this);
        });

        rightHeader.appendChild(btnUp);
        rightHeader.appendChild(btnDown);
        //Checkbox, Label & Sternchen werden in "rechten Teil" hinzugefügt
        rightHeader.appendChild(cb);
        rightHeader.appendChild(cbLabel);
        rightHeader.appendChild(reqIndicator);
        rightHeader.appendChild(deleteBtn);

        //Header wird um den "rechten Teil" (Label, Checkbox, Stern) ergänzt
        header.appendChild(titleSpan);
        header.appendChild(rightHeader);

        const body = document.createElement("div");
        body.className = "field-body";
        this.bodyEl = body;

        this.el.appendChild(header);
        this.el.appendChild(body);
        container.appendChild(this.el);
      }

      initRequiredCheckbox() {
        this.requiredCheckbox.addEventListener("change", () => {
          this.required = this.requiredCheckbox.checked;
          this.requiredIndicator.textContent = this.required ? "*" : "";
            updateFieldProperties(this.instanceId, {
                "required": this.requiredCheckbox.checked,
            });
        });
      }

      // Titel + Zusatzinfo editierbar (intern gespeichert)
      initConfigUI() {
        const config = document.createElement("div");
        config.className = "field-config";

        // Titel (intern gespeichert, nicht sichtbar im Header)
        const titleLabel = document.createElement("label");
        titleLabel.textContent = "Titel";

        const titleInput = document.createElement("input");
        titleInput.type = "text";
        titleInput.value = this.title;

        titleInput.addEventListener("input", () => {
          this.title = titleInput.value;
          updateFieldProperties(this.instanceId, {
              "title": titleInput.value,
          });
        });

        // Zusatzinfo (Tooltip)
        const infoLabel = document.createElement("label");
        infoLabel.textContent = "Zusatzinfo";

        const infoInput = document.createElement("textarea");
        infoInput.rows = 2;
        infoInput.value = this.infoText;

        infoInput.addEventListener("input", () => {
          this.infoText = infoInput.value;
          if (this.infoText.trim()) {
            this.titleEl.setAttribute("data-info", this.infoText);
          } else {
            this.titleEl.removeAttribute("data-info");
          }
          updateFieldProperties(this.instanceId, {
              "infoText": infoInput.value,
          });
        });

        config.appendChild(titleLabel);
        config.appendChild(titleInput);
        config.appendChild(infoLabel);
        config.appendChild(infoInput);

        this.bodyEl.appendChild(config);
      }

      initDrag() {
        // Mache das Feld draggable
        this.el.draggable = true;

        // Drag & Drop für Reihenfolge
        this.el.addEventListener('dragstart', (e) => {
          this.el.classList.add('dragging');
          this.el.style.opacity = '0.5';
          e.dataTransfer.effectAllowed = 'move';
        });

        this.el.addEventListener('dragend', (e) => {
          this.el.classList.remove('dragging');
          this.el.style.opacity = '1';
          this.repositionAllFields();
        });

        this.el.addEventListener('dragover', (e) => {
          e.preventDefault();
          const container = document.getElementById("form-builder");
          const draggingItem = container.querySelector('.dragging');
          if (!draggingItem || draggingItem === this.el) return;

          const siblings = [...container.querySelectorAll('.field:not(.dragging)')];
          const nextSibling = siblings.find(sibling => {
            const box = sibling.getBoundingClientRect();
            const offset = e.clientY - box.top - box.height / 2;
            return offset < 0;
          });

          if (nextSibling) {
            container.insertBefore(draggingItem, nextSibling);
            moveField(draggingItem.id, getFieldPos(nextSibling.id));
          } else {
            container.appendChild(draggingItem);
              moveField(draggingItem.id);
          }
        });

        this.el.addEventListener('dragenter', (e) => {
          e.preventDefault();
          if (!this.el.classList.contains('dragging')) {
            this.el.style.borderTop = '3px solid #007bff';
          }
        });

        this.el.addEventListener('dragleave', (e) => {
          this.el.style.borderTop = '';
        });

        this.el.addEventListener('drop', (e) => {
          e.preventDefault();
          this.el.style.borderTop = '';
        });
      }

      repositionAllFields() {
        const container = document.getElementById("form-builder");
        const allFields = container.querySelectorAll(".field");
        let currentY = 0;

        allFields.forEach(field => {
          field.style.left = "0px";
          field.style.top = currentY + "px";
          currentY += field.offsetHeight + 10;
            updateFieldProperties(field.id, {"x": field.offsetLeft, "y": field.offsetTop});
        });
      }

      // Für spätere HTML-Erzeugung vorbereiten
      toConfigObject() {
        const rect = this.el.getBoundingClientRect();
        const parentRect = this.el.parentElement.getBoundingClientRect();
        return {
          id: this.instanceId,
          type: this.type,            //Typ des Felds
          title: this.title,         // gespeicherter individueller Titel
          infoText: this.infoText,   // gespeicherter Tooltip
          required: this.required,
          x: rect.left - parentRect.left,
          y: rect.top - parentRect.top
        };
      }

        getID(){
            return this.instanceId;
        }

        getFiles(){
          return [];
        }
    }
    // Hinweis: toConfigObject() liefert später alle wichtigen Daten für HTML-Generierung

    class Textfield extends BaseField {
      constructor(options) {
        super({ ...options, type: "text" });
        this.titleEl.textContent = "Textfeld"; //Header Anzeige wird gesetzt
        updateField(this);
      }
    }

    class DropDownfield extends BaseField {
      constructor(options) {
        super({ ...options, type: "dropdown" });
        this.options = [];
        this.createSelectInput();
        this.titleEl.textContent = "Dropdown-Feld";
          updateField(this);
      }

      createSelectInput() {
        const wrapper = document.createElement("div");

        // Label für das Dropdown
        const label = document.createElement("label");
        label.textContent = "Optionen";
        label.style.display = "block";
        label.style.marginBottom = "4px";
        label.style.fontSize = "12px";

        // Container für Input und Button
        const inputContainer = document.createElement("div");
        inputContainer.style.display = "flex";
        inputContainer.style.marginBottom = "10px";
        inputContainer.style.gap = "5px";

        // Textfeld für neue Optionen
        const input = document.createElement("input");
        input.type = "text";
        input.style.flex = "1";
        input.placeholder = "Neue Option eingeben";

        // Hinzufügen Button
        const addButton = document.createElement("button");
        addButton.textContent = "Hinzufügen";
        addButton.style.padding = "4px 8px";

        // Styling für drag & drop hinzufügen
        const optionsContainer = document.createElement("div");
        optionsContainer.style.maxHeight = "150px";
        optionsContainer.style.overflowY = "auto";
        optionsContainer.style.padding = "4px";

        // Event Listener für das Hinzufügen
        addButton.addEventListener("click", () => {
            if (input.value.trim()) {
                this.addOption(input.value.trim());
                input.value = "";
                this.repositionAllFields();
            }
        });

        // Enter-Taste auch zum Hinzufügen nutzen
        input.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && input.value.trim()) {
                this.addOption(input.value.trim());
                input.value = "";
                this.repositionAllFields();
            }
        });

        inputContainer.appendChild(input);
        inputContainer.appendChild(addButton);

        wrapper.appendChild(label);
        wrapper.appendChild(inputContainer);
        wrapper.appendChild(optionsContainer);

        this.optionsContainer = optionsContainer;
        this.bodyEl.appendChild(wrapper);
      }

      addOption(text) {
        const optionDiv = document.createElement("div");
        optionDiv.style.display = "flex";
        optionDiv.style.justifyContent = "space-between";
        optionDiv.style.alignItems = "center";
        optionDiv.style.padding = "4px";
        optionDiv.style.marginBottom = "4px";
        optionDiv.style.backgroundColor = "#f5f5f5";
        optionDiv.style.borderRadius = "4px";
        optionDiv.style.cursor = "move"; // Cursor für Drag & Drop

        // Drag & Drop Attribute
        optionDiv.draggable = true;

        // Drag & Drop Event Listener
        optionDiv.addEventListener('dragstart', (e) => {
            e.target.classList.add('dragging');
            e.target.style.opacity = '0.5';
        });

        optionDiv.addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
            e.target.style.opacity = '1';
            this.updateOptions();
        });

        optionDiv.addEventListener('dragover', (e) => {
            e.preventDefault();
            const draggingItem = this.optionsContainer.querySelector('.dragging');
            const siblings = [...this.optionsContainer.querySelectorAll('div:not(.dragging)')];
            const nextSibling = siblings.find(sibling => {
                const box = sibling.getBoundingClientRect();
                const offset = e.clientY - box.top - box.height / 2;
                return offset < 0;
            });

            if (nextSibling) {
                this.optionsContainer.insertBefore(draggingItem, nextSibling);
            } else {
                this.optionsContainer.appendChild(draggingItem);
            }
        });

        // Highlight beim Draggen
        optionDiv.addEventListener('dragenter', (e) => {
            e.preventDefault();
            optionDiv.style.borderTop = '2px solid #007bff';
        });

        optionDiv.addEventListener('dragleave', (e) => {
            e.preventDefault();
            optionDiv.style.borderTop = 'none';
        });

        optionDiv.addEventListener('drop', (e) => {
            e.preventDefault();
            optionDiv.style.borderTop = 'none';
        });

        const optionText = document.createElement("span");
        optionText.textContent = text;
        optionText.style.fontSize = "12px";
        optionText.style.pointerEvents = "none"; // Verhindert Störungen beim Drag & Drop

        const deleteButton = document.createElement("button");
        deleteButton.textContent = "×";
        deleteButton.style.padding = "2px 6px";
        deleteButton.style.backgroundColor = "#ff4444";
        deleteButton.style.color = "white";
        deleteButton.style.border = "none";
        deleteButton.style.borderRadius = "3px";
        deleteButton.style.cursor = "pointer";

        deleteButton.addEventListener("click", () => {
            optionDiv.remove();
            this.updateOptions();
        });

        optionDiv.appendChild(optionText);
        optionDiv.appendChild(deleteButton);
        this.optionsContainer.appendChild(optionDiv);

        this.updateOptions();
      }

      updateOptions() {
        // Aktualisiert das Array mit allen Optionen
        this.options = Array.from(this.optionsContainer.querySelectorAll("span"))
            .map(span => span.textContent);
      }

      toConfigObject() {
        const baseConfig = super.toConfigObject();
        return {
            ...baseConfig,
            options: this.options
        };
      }
    }


    class DateField extends BaseField {

        constructor(options){
            super({...options, type: "date"});
            this.titleEl.textContent = "Datum";
            updateField(this);
        }
    }


    // Darf später nicht bearbeitbar sein, ansonsten ists gleich wie das Textfeld
    // Ist frei ziehbar, sollte auch nicht sein
    class InfoField extends BaseField {
        value = null;

        constructor(options){
            super({...options, type: "info", required: false});
            this.titleEl.textContent = "Infofeld";
            this.createInfoInput();
            updateField(this);
        }

        createInfoInput() {
            const wrapper = document.createElement("div");

            // Label
            const label = document.createElement("label");
            label.textContent = "Info Feld";
            label.style.display = "block";
            label.style.marginBottom = "4px";
            label.style.fontSize = "12px";

            // Input
            const input = document.createElement("textarea");
            input.rows = 2;
            this.value = input.value
            input.style.width = "100%";
            input.style.boxSizing = "border-box";

            input.addEventListener("input", () => {
                updateFieldProperties(this.instanceId, {
                    "value": input.value,
                });
            });

            // Combine the ELEMENTS!!!!
            wrapper.appendChild(label);
            wrapper.appendChild(input);
            this.bodyEl.appendChild(wrapper);
        }

        toConfigObject() {
            const rect = this.el.getBoundingClientRect();
            const parentRect = this.el.parentElement.getBoundingClientRect();
            return {
                id: this.instanceId,
                type: this.type,
                title: this.title,         // gespeicherter individueller Titel
                infoText: this.infoText,   // gespeicherter Tooltip
                required: this.required,
                value: this.value,
                x: rect.left - parentRect.left,
                y: rect.top - parentRect.top
            };
        }
    }


    class PictureField extends BaseField {
        //speichern im Base64-Format
        picture64 = null

        //Konstruktor ruft Basisklasse auf und setzt Feldtyp fest
        constructor(options){
            super({...options, type: "picture"});
            this.titleEl.textContent = "Bild";
            this.createPictureInput();
            updateField(this);
        }

        createPictureInput() {
            const wrapper = document.createElement("div");
            let upload = this.pircture64; //Lokale Kopie des gespeicherten Base64-Strings

            // Label
            const label = document.createElement("label");
            label.textContent = "Bild Feld";
            label.style.display = "block";
            label.style.marginBottom = "4px";
            label.style.fontSize = "12px";

            //Bild-Preview-Element
            const img = document.createElement("img")
            img.src = "#"
            img.alt = "Preview"

            // Input
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*";

            //Upload wird als Base64 eingelesen, gespeichert und Preview aktualisiert
            const id = this;
            input.onchange = function () {
                console.log("test");
                let file = this.files[0];
                let reader = new FileReader();

                reader.onload = function (event) {
                    let base64String = event.target.result;
                    console.log(base64String);
                    upload = event.target.result;
                    id.bodyEl.children[1].children[2].src = base64String
                    console.log(id.bodyEl.children[1].children[2].src)
                    id.repositionAllFields();
                    updateFieldProperties(this.instanceId, {
                        "value": base64String,
                    });
                };
                reader.readAsDataURL(file);
            }
            input.style.width = "100%";
            input.style.boxSizing = "border-box";
            console.log(input);
            console.log(this.picture64)



            // Combine the ELEMENTS!!!!
            wrapper.appendChild(label);
            wrapper.appendChild(input);
            wrapper.appendChild(img)
            this.bodyEl.appendChild(wrapper);
        }

    }


    class FileField extends BaseField {

        constructor(options){
            super({...options, type: "file"});
            this.titleEl.textContent = "Datei";
        }
    }

    class NumberField extends BaseField {

        constructor(options){
            super({...options, type: "number"});
            this.titleEl.textContent = "Zahlenfeld";
            updateField(this);
        }
    }


    class Radio_MultipleChoicefield extends BaseField {
      constructor(options) {
        super({ ...options, type: "radio_multiple" });
        this.options = [];
        this.allowMultiple = false;
        this.createOptionsInput();
        this.titleEl.textContent = "Radio-/Multiple-Choice-Feld";
          updateField(this);
      }

      createOptionsInput() {
        const wrapper = document.createElement("div");

        // Checkbox für Mehrfachauswahl
        const multipleChoiceContainer = document.createElement("div");
        multipleChoiceContainer.style.marginBottom = "10px";

        const multipleChoice = document.createElement("input");
        multipleChoice.type = "checkbox";
        multipleChoice.id = "multipleChoice_" + this.instanceId;
        multipleChoice.checked = this.allowMultiple;

        const multipleChoiceLabel = document.createElement("label");
        multipleChoiceLabel.htmlFor = "multipleChoice_" + this.instanceId;
        multipleChoiceLabel.textContent = "Mehrfachauswahl erlauben";
        multipleChoiceLabel.style.fontSize = "12px";
        multipleChoiceLabel.style.marginLeft = "5px";

        multipleChoice.addEventListener("change", () => {
            this.allowMultiple = multipleChoice.checked;
            this.updateOptionsPreview();
        });

        multipleChoiceContainer.appendChild(multipleChoice);
        multipleChoiceContainer.appendChild(multipleChoiceLabel);

        // Label für die Optionen
        const label = document.createElement("label");
        label.textContent = "Auswahlmöglichkeiten";
        label.style.display = "block";
        label.style.marginBottom = "4px";
        label.style.fontSize = "12px";

        // Container für Input und Button
        const inputContainer = document.createElement("div");
        inputContainer.style.display = "flex";
        inputContainer.style.marginBottom = "10px";
        inputContainer.style.gap = "5px";

        // Textfeld für neue Optionen
        const input = document.createElement("input");
        input.type = "text";
        input.style.flex = "1";
        input.placeholder = "Neue Auswahlmöglichkeit eingeben";

        // Hinzufügen Button
        const addButton = document.createElement("button");
        addButton.textContent = "Hinzufügen";
        addButton.style.padding = "4px 8px";

        // Container für die Optionsliste
        const optionsContainer = document.createElement("div");
        optionsContainer.style.maxHeight = "150px";
        optionsContainer.style.overflowY = "auto";
        optionsContainer.style.padding = "4px";

        // Event Listener für das Hinzufügen
        addButton.addEventListener("click", () => {
            if (input.value.trim()) {
                this.addOption(input.value.trim());
                input.value = "";
                this.repositionAllFields();
            }
        });

        // Enter-Taste auch zum Hinzufügen nutzen
        input.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && input.value.trim()) {
                this.addOption(input.value.trim());
                input.value = "";
                this.repositionAllFields();
            }
        });

        wrapper.appendChild(multipleChoiceContainer);
        wrapper.appendChild(label);
        inputContainer.appendChild(input);
        inputContainer.appendChild(addButton);
        wrapper.appendChild(inputContainer);
        wrapper.appendChild(optionsContainer);

        this.optionsContainer = optionsContainer;
        this.bodyEl.appendChild(wrapper);
      }

      addOption(text) {
        const optionDiv = document.createElement("div");
        optionDiv.style.display = "flex";
        optionDiv.style.justifyContent = "space-between";
        optionDiv.style.alignItems = "center";
        optionDiv.style.padding = "4px";
        optionDiv.style.marginBottom = "4px";
        optionDiv.style.backgroundColor = "#f5f5f5";
        optionDiv.style.borderRadius = "4px";
        optionDiv.style.cursor = "move";

        optionDiv.draggable = true;

        // Radio/Checkbox Vorschau
        const inputPreview = document.createElement("input");
        inputPreview.type = this.allowMultiple ? "checkbox" : "radio";
        inputPreview.name = "preview_" + this.instanceId;
        inputPreview.style.marginRight = "8px";
        inputPreview.style.cursor = "default";
        inputPreview.onclick = (e) => e.preventDefault();

        //Layout
        const optionText = document.createElement("span");
        optionText.textContent = text;
        optionText.style.fontSize = "12px";
        optionText.style.flex = "1";
        optionText.style.pointerEvents = "none";

        //Delete Button Format
        const deleteButton = document.createElement("button");
        deleteButton.textContent = "×";
        deleteButton.style.padding = "2px 6px";
        deleteButton.style.backgroundColor = "#ff4444";
        deleteButton.style.color = "white";
        deleteButton.style.border = "none";
        deleteButton.style.borderRadius = "3px";
        deleteButton.style.cursor = "pointer";
        deleteButton.style.marginLeft = "8px";

        // Drag & Drop Event Listener
        this.addDragListeners(optionDiv);

        deleteButton.addEventListener("click", () => {
            optionDiv.remove();
            this.updateOptions();
        });

        const textContainer = document.createElement("div");
        textContainer.style.display = "flex";
        textContainer.style.alignItems = "center";
        textContainer.style.flex = "1";
        textContainer.appendChild(inputPreview);
        textContainer.appendChild(optionText);

        optionDiv.appendChild(textContainer);
        optionDiv.appendChild(deleteButton);
        this.optionsContainer.appendChild(optionDiv);

        this.updateOptions();
      }

      addDragListeners(optionDiv) {
        optionDiv.addEventListener('dragstart', (e) => {
            e.target.classList.add('dragging');
            e.target.style.opacity = '0.5';
        });

        optionDiv.addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
            e.target.style.opacity = '1';
            this.updateOptions();
        });

        optionDiv.addEventListener('dragover', (e) => {
            e.preventDefault();
            const draggingItem = this.optionsContainer.querySelector('.dragging');
            const siblings = [...this.optionsContainer.querySelectorAll('div:not(.dragging)')];
            const nextSibling = siblings.find(sibling => {
                const box = sibling.getBoundingClientRect();
                const offset = e.clientY - box.top - box.height / 2;
                return offset < 0;
            });

            if (nextSibling) {
                this.optionsContainer.insertBefore(draggingItem, nextSibling);
            } else {
                this.optionsContainer.appendChild(draggingItem);
            }
        });

        optionDiv.addEventListener('dragenter', (e) => {
            e.preventDefault();
            optionDiv.style.borderTop = '2px solid #007bff';
        });

        optionDiv.addEventListener('dragleave', (e) => {
            e.preventDefault();
            optionDiv.style.borderTop = 'none';
        });

        optionDiv.addEventListener('drop', (e) => {
            e.preventDefault();
            optionDiv.style.borderTop = 'none';
        });
      }

      updateOptionsPreview() {
        const inputs = this.optionsContainer.querySelectorAll('input');
        inputs.forEach(input => {
            input.type = this.allowMultiple ? "checkbox" : "radio";
        });
      }

      updateOptions() {
        this.options = Array.from(this.optionsContainer.querySelectorAll("span"))
            .map(span => span.textContent);
      }

      toConfigObject() {
        const baseConfig = super.toConfigObject();
        return {
            ...baseConfig,
            options: this.options,
            allowMultiple: this.allowMultiple
        };
      }
    }


// Funktionen zum Erstellen der verschiedenen Feldtypen mit versetzten Positionen
let fieldOffsetCounter = 0;
let lastFieldHeight = 0;
let currentYPosition = 0;

function calculateNextPosition() {
    const container = document.getElementById("form-builder");
    const allFields = container.querySelectorAll(".field");

    if (allFields.length === 0) {
        currentYPosition = 0;
        return 0;
    }

    // Finde das unterste Feld
    let maxBottom = 0;
    allFields.forEach(field => {
        const top = parseInt(field.style.top) || 0;
        const height = field.offsetHeight;
        const bottom = top + height;
        if (bottom > maxBottom) {
            maxBottom = bottom;
        }
    });

    // Füge einen kleinen Abstand hinzu
    currentYPosition = maxBottom + 10;
    return currentYPosition;
}

function addTextField() {
    new Textfield({
        title: "",
        infoText: "",
        required: false,
        x: 0,
        y: calculateNextPosition()
    });
}

function addInfoField() {
    new InfoField({
        title: "",
        infoText: "",
        required: false,
        x: 0,
        y: calculateNextPosition()
    });
}

function addFileField() {
    new FileField({
        title: "",
        infoText: "",
        required: false,
        x: 0,
        y: calculateNextPosition()
    });
}

function addNumberField() {
    new NumberField({
        title: "",
        infoText: "",
        required: false,
        x: 0,
        y: calculateNextPosition()
    });
}

function addDateField() {
    new DateField({
        title: "",
        infoText: "",
        required: false,
        x: 0,
        y: calculateNextPosition()
    });
}

function addPictureField() {
    new PictureField({
        title: "",
        infoText: "",
        required: false,
        x: 0,
        y: calculateNextPosition()
    });
}

function addDropdownField() {
    new DropDownfield({
        title: "",
        infoText: "",
        required: false,
        x: 0,
        y: calculateNextPosition()
    });
}

function addMultipleChoiceField() {
    new Radio_MultipleChoicefield({
        title: "",
        infoText: "",
        required: false,
        x: 0,
        y: calculateNextPosition()
    });
}

// Drag & Drop für den Container aktivieren
const formBuilder = document.getElementById("form-builder");

formBuilder.addEventListener('dragover', (e) => {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
});

formBuilder.addEventListener('drop', (e) => {
  e.preventDefault();
});
  </script>
  <script>
      let specs = {
          "vars": {
              "id-counter": 0,
              "title": "",
              "image": null
          },
          "form": {
              "fields": [],
              "scripts": []
          },
          "eval": {
              "fields": [],
              "scripts": []
          }
      }

      let defaultSpecs = {
          "form": {
              "fields": [],
              "scripts": []
          },
          "eval": {
              "fields": [],
              "scripts": []
          }
      }


      function render(givenSpecs = null, formType = "form") {
          let container = document.getElementById("form-builder");
          container.innerHTML = "";

          let formSpecs = givenSpecs[formType]["fields"]
          if(givenSpecs === null) {
              formSpecs = specs[formType]["fields"];
          }

          for(let i = 0; i < formSpecs.length; i++){
              console.log("started"+i+". time looping");
              renderField(formSpecs[i]["class"], formSpecs[i]["config"]);
              console.log("created a "+formSpecs[i]["class"]);
              console.log("finished "+i+". time looping");
          }

          if(givenSpecs !== null)
              specs = givenSpecs;
      }

      function renderField(type, args){
          switch (type){
              case "Textfield":
                  return new Textfield(args);
              case "DropDownfield":
                  return new DropDownfield(args);
              case "DateField":
                  return new DateField(args);
              case "InfoField":
                  return new InfoField(args);
              case "PictureField":
                  return new PictureField(args);
              case "FileField":
                  return new FileField(args);
              case "NumberField":
                  return new NumberField(args);
              case "Radio_MultipleChoicefield":
                  return new Radio_MultipleChoicefield(args);
              default:
                  return null;
          }
      }

      function insertField(field, formType = "form"){
          let id = field.getID();
          let pos = getFieldPos(id);
          if(pos != null){
              return updateField(field, formType);
          }
          else {
              let pos = specs[formType]["fields"].length;
              specs[formType]["fields"][pos] = {
                  "id" : id,
                  "class": field.constructor.name,
                  "htmlType": "body",
                  "config": field.toConfigObject(),
                  "files": field.getFiles()
              }
              return true;
          }
      }

      function updateFieldProperties(fieldID, attributes, formType = "form"){
          if(attributes == null)
              return;
          let pos = getFieldPos(fieldID);
          if (pos == null)
              return;
          specs[formType]["fields"][pos]["config"] = {...specs[formType]["fields"][pos]["config"], ...attributes};
      }

      function moveField(fieldID, targetPos = null, formType = "form", pos = null){
          console.log("field id: "+fieldID);
          console.log("field at pos "+getFieldPos(fieldID)+" should be moved to "+targetPos);
          if(pos == null)
              pos = getFieldPos(fieldID);

          if(targetPos == null)
              targetPos = specs[formType]["fields"].length-1;

          if(targetPos === pos)
              return true;

          let fieldSpecs = specs[formType]["fields"][pos];
          if(targetPos < pos){
              while(targetPos < pos){
                  specs[formType]["fields"][pos] = specs[formType]["fields"][pos-1];
                  pos--;
              }
              specs[formType]["fields"][pos] = fieldSpecs;
          }
          else{
              while(targetPos > pos){
                  specs[formType]["fields"][pos] = specs[formType]["fields"][pos+1];
                  pos++;
              }
              specs[formType]["fields"][pos] = fieldSpecs;
          }

          console.log("Element moved to position "+targetPos);

          return true;
      }

      function updateField(field, formType = "form", pos = null){
          if(field == null || !(field instanceof BaseField))
              return false;

          if(pos == null)
              pos = getFieldPos(field.getID());

          let fieldSpecs = specs[formType]["fields"][pos];
          fieldSpecs["htmlType"] = "body";
          fieldSpecs["config"] = field.toConfigObject();
          fieldSpecs["files"] = field.getFiles();

          return true;
      }

      function getFieldPos(fieldID, formType = "form"){
          let fields = specs[formType]["fields"];
          console.log(fields);
          if(fields != null){
              let i = 0;
              while(i < fields.length){
                  if(fields[i] != null && fields[i]["id"] == fieldID)
                      return i;
                  i++;
              }
          }
          else {
              return null;
          }
      }

      function removeField(field, formType = "form"){
          if(field == null || !(field instanceof BaseField))
              return false;

          let fields = specs[formType]["fields"];
          moveField(field.getID(), fields.length-1);
          fields.pop();
      }

  </script>
  <script>
      // script for updating and saving
      function downloadBuilder(){
          let jsonLink = document.createElement('a');
          console.log(specs);
          jsonLink.href = URL.createObjectURL(new File([getSpecsBlob()], "specs.json"));
          jsonLink.download = 'specs.json';
          jsonLink.click();
      }

      function exportBuilder(){
        let formLink = document.createElement('a');
        formLink.href = URL.createObjectURL(new File([getFormBlob()], "form.html"));
        formLink.download = 'form.html';
        formLink.click();

        let auswertungLink = document.createElement('a');
        auswertungLink.href = URL.createObjectURL(new File([getAuswertungBlob()], "auswertung.html"));
        auswertungLink.download = 'auswertung.html';
        auswertungLink.click();
}

      function importBuilder(){
          let file = document.getElementById("importFile").files[0];
          if(file){
              let reader = new FileReader();
              reader.readAsText(file, "UTF-8");
              reader.onloadend = function(evt){
                  let loadedSpecs = JSON.parse(evt.target.result);
                  render(loadedSpecs);
              }
          }
      }


      function getSpecsBlob(){
          let jsonSpecs = new JsonObj(specs);
          return jsonSpecs.getDownloadFile();
      }

      function getFormBlob(){
          let htmlForm = new HtmlObj()
          htmlForm.appendBody(returnFormHtml(specs));
          htmlForm.finish();
          return htmlForm.getDownloadFile();
      }

      function getEvalBlob(){
          let htmlEval = createEvalFromJson();
          return htmlEval.getDownloadFile();
      }

      class Obj{
          constructor() {

          }

          getDownloadFile(data, type){
              return new Blob([data], {type: type});
          }
      }

      class HtmlObj extends Obj{
          fullHtml = "";
          htmlHeader = "<header>";
          htmlBody = "<body>";
          htmlFooter = "<footer>";

          constructor(html = "<!DOCTYPE html><html lang=\"de\">"){
              super();
              this.fullHtml = html;
          }

          append(jsonHtml){
              if(jsonHtml != null && typeof jsonHtml === 'object' && jsonHtml.html){
                  if (jsonHtml.type && jsonHtml.type === "header"){
                      this.htmlHeader += jsonHtml.html;
                  }
                  else if (jsonHtml.type && jsonHtml.type === "body") {
                      this.htmlBody += jsonHtml.html;
                  }
                  else if (jsonHtml.type && jsonHtml.type === "footer") {
                      this.htmlFooter += jsonHtml.html;
                  }
              }
              return this;
          }

          finish(){
              this.htmlHeader += "</header>";
              this.htmlBody += "</body>";
              this.htmlFooter += "</footer>";
              this.fullHtml += this.htmlHeader+this.htmlBody+this.htmlFooter+"</html>";
              return this;
          }

          getDownloadFile() {
              return super.getDownloadFile(this.fullHtml, 'text/html');
          }

          getContent() {
              return this.fullHtml;
          }

          appendBody(html){
              this.htmlBody += html;
          }
      }

      class JsonObj extends Obj{
          json = {}
          constructor(json) {
              super();
              this.json = json;
          }

          getDownloadFile() {
              return super.getDownloadFile(JSON.stringify(this.json), 'application/json');
          }

          getContent() {
              return this.json;
          }
      }
      document.getElementById("saveBtn").onclick = function() {downloadBuilder()};
      document.getElementById("exportBtn").onclick = function() {exportBuilder()};
      document.getElementById("importFile").onchange = function() {
          importBuilder();
          document.getElementById("importFile").value = "";
      };
  </script>
  <script>
function createAuswertungHTML() {
    return `<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Auswertung</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .title-box {
            background: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .title-box h1 {
            margin: 0;
            font-size: 28px;
        }

        .upload-box {
            background: white;
            padding: 20px;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .upload-btn {
            background-color: #04AA6D;
            color: white;
            padding: 16px 32px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 5px;
        }

        .upload-btn:hover {
            background-color: #3e8e41;
        }

        .zip-btn {
            background-color: #ff8800;
        }

        .zip-btn:hover {
            background-color: #cc6600;
        }

        #fileInput, #zipInput {
            display: none;
        }

        .matrix-container {
            background: white;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid black;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background-color: #f5f5f5;
        }

        tr:hover {
            background-color: #e9ecef;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .error-message {
            background: #ff4444;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }

        .success-message {
            background: #04AA6D;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }

        .file-info {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
        .dropdown {
            position: relative;
            top: 0;
            left: 0;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: fixed;
            background-color: #f1f1f1;
            min-width: 160px;
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
            z-index: 2;
        }

        .dropdown-content button {
            color: black;
            width: 100%;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown-content button:hover {background-color: #ddd;}
        .dropdown:hover .dropdown-content {display: block;}
        .dropdown:hover .dropbtn {background-color: #3e8e41;}
    </style>
</head>
<body>
<div class="container">
    <div class="title-box">
        <h1>Auswertung</h1>
    </div>

    <div class="upload-box">
        <input type="file" id="fileInput" accept=".json" multiple>
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
            JSON Dateien hochladen
        </button>

        <input type="file" id="zipInput" accept=".zip" multiple>
        <button class="upload-btn zip-btn" onclick="document.getElementById('zipInput').click()">
            ZIP Dateien hochladen
        </button>

        <div class="dropdown">
            <button class="upload-btn">Exportieren</button>
            <div class="dropdown-content">
                <button onclick="exportCsv()">CSV</button>
                <button onclick="exportPdf()">PDF</button>
            </div>
        </div>

        <div class="file-info" id="fileInfo"></div>
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
    </div>

    <div class="matrix-container">
        <div id="tableContainer">
            <div class="no-data">Bitte laden Sie JSON- oder ZIP-Dateien, um die Auswertung anzuzeigen.</div>
        </div>
    </div>
</div>

<script>
    let allData = [];
    let fieldTitles = [];

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const files = e.target.files;
        if (files.length === 0) return;

        allData = [];
        fieldTitles = [];

        const fileInfo = document.getElementById('fileInfo');
        fileInfo.textContent = \`\${files.length} JSON-Datei(en) ausgewählt\`;

        let filesProcessed = 0;

        Array.from(files).forEach(file => {
            const reader = new FileReader();

            reader.onload = function(event) {
                try {
                    const jsonData = JSON.parse(event.target.result);
                    processJsonData(jsonData, file.name);
                    filesProcessed++;

                    if (filesProcessed === files.length) {
                        generateTable();
                    }
                } catch (error) {
                    showError(\`Fehler beim Laden von \${file.name}: \${error.message}\`);
                }
            };

            reader.onerror = function() {
                showError(\`Fehler beim Lesen von \${file.name}\`);
            };

            reader.readAsText(file);
        });
    });

    document.getElementById('zipInput').addEventListener('change', async function(e) {
        const files = e.target.files;
        if (files.length === 0) return;

        allData = [];
        fieldTitles = [];

        let totalJsonFiles = 0;

        for (const file of files) {
            try {
                const jsonFiles = await processZipFile(file);
                totalJsonFiles += jsonFiles;
            } catch (error) {
                showError(\`Fehler beim Verarbeiten von \${file.name}: \${error.message}\`);
            }
        }

        if (totalJsonFiles > 0) {
            showSuccess(\`\${files.length} ZIP-Datei(en) verarbeitet, \${totalJsonFiles} JSON-Datei(en) gefunden\`);
            generateTable();
        } else {
            showError('Keine JSON-Dateien in den ZIP-Archiven gefunden');
        }

        document.getElementById('zipInput').value = '';
    });

    async function processZipFile(zipFile) {
        const arrayBuffer = await zipFile.arrayBuffer();
        const jsonFiles = await extractJsonFromZip(arrayBuffer);
        
        jsonFiles.forEach(jsonFile => {
            try {
                const jsonData = JSON.parse(jsonFile.content);
                processJsonData(jsonData, jsonFile.name);
            } catch (error) {
                console.error(\`Fehler beim Parsen von \${jsonFile.name}:\`, error);
            }
        });

        return jsonFiles.length;
    }

    async function extractJsonFromZip(arrayBuffer) {
        const view = new DataView(arrayBuffer);
        const jsonFiles = [];
        let offset = 0;

        while (offset < arrayBuffer.byteLength - 4) {
            const signature = view.getUint32(offset, true);

            if (signature === 0x04034b50) {
                const compressionMethod = view.getUint16(offset + 8, true);
                const compressedSize = view.getUint32(offset + 18, true);
                const uncompressedSize = view.getUint32(offset + 22, true);
                const fileNameLength = view.getUint16(offset + 26, true);
                const extraFieldLength = view.getUint16(offset + 28, true);

                const fileNameStart = offset + 30;
                const fileNameBytes = new Uint8Array(arrayBuffer, fileNameStart, fileNameLength);
                const fileName = new TextDecoder().decode(fileNameBytes);

                const dataStart = fileNameStart + fileNameLength + extraFieldLength;

                if (fileName.toLowerCase().endsWith('.json') && !fileName.includes('__MACOSX') && !fileName.endsWith('/')) {
                    try {
                        let content;
                        const compressedData = new Uint8Array(arrayBuffer, dataStart, compressedSize);

                        if (compressionMethod === 0) {
                            content = new TextDecoder().decode(compressedData);
                        } else if (compressionMethod === 8) {
                            const decompressed = await decompressDeflate(compressedData);
                            content = new TextDecoder().decode(decompressed);
                        } else {
                            console.warn(\`Nicht unterstützte Komprimierung (\${compressionMethod}) für: \${fileName}\`);
                            offset = dataStart + compressedSize;
                            continue;
                        }

                        jsonFiles.push({ name: fileName, content: content });
                    } catch (error) {
                        console.error(\`Fehler beim Extrahieren von \${fileName}:\`, error);
                    }
                }

                offset = dataStart + compressedSize;
            } else {
                offset++;
            }
        }

        return jsonFiles;
    }

    async function decompressDeflate(compressedData) {
        if (typeof DecompressionStream !== 'undefined') {
            const ds = new DecompressionStream('deflate-raw');
            const writer = ds.writable.getWriter();
            writer.write(compressedData);
            writer.close();

            const chunks = [];
            const reader = ds.readable.getReader();
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                chunks.push(value);
            }

            const totalLength = chunks.reduce((acc, chunk) => acc + chunk.length, 0);
            const result = new Uint8Array(totalLength);
            let offset = 0;
            for (const chunk of chunks) {
                result.set(chunk, offset);
                offset += chunk.length;
            }

            return result;
        } else {
            throw new Error('Komprimierte ZIP-Dateien werden in diesem Browser nicht unterstützt');
        }
    }

    function processJsonData(data, fileName) {
        console.log('Processing:', fileName, data);
        const rowData = {
            fileName: fileName,
            values: {}
        };

        if (data.form && data.form.fields && Array.isArray(data.form.fields)) {
            data.form.fields.forEach(field => {
                const title = field.config.title || field.class || 'Unbekannt';
                const value = getFieldValue(field.config);
                console.log('Field:', title, '=', value);

                if (!fieldTitles.includes(title)) {
                    fieldTitles.push(title);
                }
                rowData.values[title] = value;
            });
        } else if (data && Array.isArray(data)) {
            data.forEach(field => {
                const title = field.title || 'Unbekannt';
                if (!fieldTitles.includes(title)) {
                    fieldTitles.push(title);
                }
                rowData.values[title] = field.value;
            });
        } else {
            console.warn('Keine Felder in:', fileName, data);
        }

        allData.push(rowData);
        console.log('Current allData:', allData);
        console.log('Current fieldTitles:', fieldTitles);
    }

    function getFieldValue(field) {
        if (field.value !== undefined && field.value !== null && field.value !== '') {
            return field.value;
        }
        if (field.options && Array.isArray(field.options)) {
            return field.options.join(', ');
        }
        return '-';
    }

    function generateTable() {
        const tableContainer = document.getElementById('tableContainer');

        console.log('Generating table with', allData.length, 'rows and', fieldTitles.length, 'columns');

        if (allData.length === 0 || fieldTitles.length === 0) {
            tableContainer.innerHTML = '<div class="no-data">Keine Daten gefunden.</div>';
            return;
        }

        let tableHTML = '<table><thead><tr>';
        tableHTML += '<th>Dateiname</th>';

        fieldTitles.forEach(title => {
            tableHTML += \`<th>\${escapeHtml(title)}</th>\`;
        });

        tableHTML += '</tr></thead><tbody>';

        allData.forEach(row => {
            tableHTML += '<tr>';
            tableHTML += \`<td>\${escapeHtml(row.fileName)}</td>\`;

            fieldTitles.forEach(title => {
                const value = row.values[title] || '-';
                tableHTML += \`<td>\${escapeHtml(String(value))}</td>\`;
            });

            tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table>';
        tableContainer.innerHTML = tableHTML;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';

        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = message;
        successDiv.style.display = 'block';

        setTimeout(() => {
            successDiv.style.display = 'none';
        }, 5000);
    }
<`+`/script>
    <script>
        function exportPdf() {
            let table = document.getElementById("tableContainer").innerHTML;
            let printWindow = window.open("", "", "height=500, width=500");
            printWindow.document.open();
            const htmlContent = '<html lang="De">\\n' +
                '<head>\\n' +
                '<title>Auswertung</title>\\n' +
                '<style>\\n' +
                'body { font-family: Arial, sans-serif; }\\n' +
                'h1 { color: #333; }\\n' +
                'th, td {\\n' +
                'border: 1px solid black;\\n' +
                'padding: 12px;\\n' +
                'text-align: left;\\n' +
                '}\\n' +
                '</style>\\n' +
                '</head>\\n' +
                '<body>\\n' +
                '<h1>Auswertung</h1>\\n' +
                table +
                '</body>\\n' +
                '</html>';

            printWindow.document.write(htmlContent)
            printWindow.document.close();
            printWindow.print();
        }

        function exportCsv() {
            let csv_data = [];
            let rows = document.getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                let cols = rows[i].querySelectorAll("td,th");

                let csvrow = [];
                for (let j = 0; j < cols.length; j++) {
                    csvrow.push(cols[j].innerHTML);
                }

                csv_data.push(csvrow.join(","));
            }

            csv_data = csv_data.join("\\n");

            downloadCsv(csv_data)

        }

        function downloadCsv(csv_data) {
            CSVFile = new Blob([csv_data], {type: "text/csv"});

            let temp_link = document.createElement('a');

            temp_link.download = \`Auswertung.csv\`;
        let url = window.URL.createObjectURL(CSVFile);
        temp_link.href = url;

        temp_link.style.display = "none";
        document.body.appendChild(temp_link);

        temp_link.click();
        document.body.removeChild(temp_link);
    }

<`+`/script>
</body>
</html>`;
}

function getAuswertungBlob() {
    const htmlAuswertung = createAuswertungHTML();
    return new Blob([htmlAuswertung], {type: 'text/html'});
}
  </script>
<script>
    function returnFormHtml(specs){
        return "<!DOCTYPE html>\n" +
        "<html lang=\"de\">\n" +
        "<head>\n" +
        "    <meta charset=\"UTF-8\">\n" +
        "    <title>Formular</title>\n" +
        "    <style>\n" +
        "        body {\n" +
        "            font-family: Arial, sans-serif;\n" +
        "            margin: 20px;\n" +
        "            background: #f0f0f0;\n" +
        "        }\n" +
        "        .field {\n" +
        "            background: #ffffff;\n" +
        "            border: 1px solid #ccc;\n" +
        "            border-radius: 6px;\n" +
        "            box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n" +
        "            margin-bottom: 15px;\n" +
        "            padding: 15px;\n" +
        "        }\n" +
        "        .field-header {\n" +
        "            background: #007bff;\n" +
        "            color: #fff;\n" +
        "            padding: 8px 10px;\n" +
        "            display: flex;\n" +
        "            align-items: center;\n" +
        "            justify-content: space-between;\n" +
        "            border-radius: 6px 6px 0 0;\n" +
        "            margin: -15px -15px 10px -15px;\n" +
        "        }\n" +
        "        .field-title {\n" +
        "            font-size: 14px;\n" +
        "            font-weight: bold;\n" +
        "        }\n" +
        "        .field-required {\n" +
        "            display: flex;\n" +
        "            align-items: center;\n" +
        "            gap: 4px;\n" +
        "            font-size: 12px;\n" +
        "        }\n" +
        "        .field-required-indicator {\n" +
        "            color: #ffeb3b;\n" +
        "            font-size: 14px;\n" +
        "        }\n" +
        "        .field-body {\n" +
        "            padding: 10px 0;\n" +
        "        }\n" +
        "        label {\n" +
        "            display: block;\n" +
        "            margin-bottom: 4px;\n" +
        "            font-size: 14px;\n" +
        "            font-weight: bold;\n" +
        "        }\n" +
        "        input, textarea, select {\n" +
        "            width: 100%;\n" +
        "            box-sizing: border-box;\n" +
        "            padding: 8px;\n" +
        "            font-size: 14px;\n" +
        "            border: 1px solid #ccc;\n" +
        "            border-radius: 4px;\n" +
        "        }\n" +
        "        img {\n" +
        "            max-width: 100%;\n" +
        "            height: auto;\n" +
        "        }\n" +
        "    </style>\n" +
        "</head>\n" +
        "<body>\n" +
        "    <div id=\"form-builder\"></div>\n" +
        "    <script>\n" +
        "        const specs = "+JSON.stringify(specs)+";\n" +
        "        \n" +
        "        function renderForm(givenSpecs, formType = \"form\") {\n" +
        "            const container = document.getElementById(\"form-builder\");\n" +
        "            if (!container) {\n" +
        "                console.error('Container #form-builder nicht gefunden');\n" +
        "                return;\n" +
        "            }\n" +
        "            container.innerHTML = \"\";\n" +
        "\n" +
        "            const formSpecs = givenSpecs[formType][\"fields\"];\n" +
        "\n" +
        "            for(let i = 0; i < formSpecs.length; i++){\n" +
        "                renderFormField(formSpecs[i][\"class\"], formSpecs[i][\"config\"]);\n" +
        "            }\n" +
        "        }\n" +
        "\n" +
        "        function renderFormField(type, config){\n" +
        "            switch (type){\n" +
        "                case \"Textfield\":\n" +
        "                    return new TextFormField(config);\n" +
        "                case \"DropDownfield\":\n" +
        "                    return new DropdownFormField(config);\n" +
        "                case \"DateField\":\n" +
        "                    return new DateFormField(config);\n" +
        "                case \"InfoField\":\n" +
        "                    return new InfoFormField(config);\n" +
        "                case \"PictureField\":\n" +
        "                    return new PictureFormField(config);\n" +
        "                case \"FileField\":\n" +
        "                    return new FileFormField(config);\n" +
        "                case \"NumberField\":\n" +
        "                    return new NumberFormField(config);\n" +
        "                case \"Radio_MultipleChoicefield\":\n" +
        "                    return new RadioMultipleChoiceFormField(config);\n" +
        "                default:\n" +
        "                    return null;\n" +
        "            }\n" +
        "        }\n" +
        "        \n" +
        "        class BaseFormField{\n" +
        "            constructor(config) {\n" +
        "                this.instanceId = config.id;\n" +
        "                this.type = config.type || \"base\";\n" +
        "                this.title = config.title || \"\";\n" +
        "                this.infoText = config.infoText || \"\";\n" +
        "                this.required = config.required || false;\n" +
        "                this.x = config.x || 0;\n" +
        "                this.y = config.y || 0;\n" +
        "                \n" +
        "                this.createFormField();\n" +
        "            }\n" +
        "\n" +
        "            createFormField() {\n" +
        "                const container = document.getElementById(\"form-builder\");\n" +
        "\n" +
        "                this.el = document.createElement(\"div\");\n" +
        "                this.el.className = \"field\";\n" +
        "                this.el.id = String(this.instanceId);\n" +
        "\n" +
        "                const header = document.createElement(\"div\");\n" +
        "                header.className = \"field-header\";\n" +
        "\n" +
        "                const titleSpan = document.createElement(\"span\");\n" +
        "                titleSpan.className = \"field-title\";\n" +
        "                titleSpan.textContent = this.title || \"Feld\";\n" +
        "                if (this.infoText) {\n" +
        "                    titleSpan.setAttribute(\"title\", this.infoText);\n" +
        "                }\n" +
        "\n" +
        "                const rightHeader = document.createElement(\"div\");\n" +
        "                rightHeader.className = \"field-required\";\n" +
        "                \n" +
        "                if(this.required) {\n" +
        "                    const cbLabel = document.createElement(\"span\");\n" +
        "                    cbLabel.textContent = \"Pflicht\";\n" +
        "\n" +
        "                    const reqIndicator = document.createElement(\"span\");\n" +
        "                    reqIndicator.className = \"field-required-indicator\";\n" +
        "                    reqIndicator.textContent = \"*\";\n" +
        "                    \n" +
        "                    rightHeader.appendChild(cbLabel);\n" +
        "                    rightHeader.appendChild(reqIndicator);\n" +
        "                }\n" +
        "\n" +
        "                header.appendChild(titleSpan);\n" +
        "                header.appendChild(rightHeader);\n" +
        "\n" +
        "                const body = document.createElement(\"div\");\n" +
        "                body.className = \"field-body\";\n" +
        "                this.bodyEl = body;\n" +
        "\n" +
        "                this.el.appendChild(header);\n" +
        "                this.el.appendChild(body);\n" +
        "                container.appendChild(this.el);\n" +
        "            }\n" +
        "        }\n" +
        "        \n" +
        "        class TextFormField extends BaseFormField{\n" +
        "            constructor(config) {\n" +
        "                super(config);\n" +
        "                this.createTextInput();\n" +
        "            }\n" +
        "\n" +
        "            createTextInput() {\n" +
        "                const wrapper = document.createElement(\"div\");\n" +
        "                const label = document.createElement(\"label\");\n" +
        "                label.textContent = this.title;\n" +
        "\n" +
        "                const input = document.createElement(\"input\");\n" +
        "                input.type = \"text\";\n" +
        "                input.id = \"field_\" + this.instanceId;\n" +
        "\n" +
        "                wrapper.appendChild(label);\n" +
        "                wrapper.appendChild(input);\n" +
        "                this.bodyEl.appendChild(wrapper);\n" +
        "            }\n" +
        "        }\n" +
        "        \n" +
        "        class DropdownFormField extends BaseFormField{\n" +
        "            constructor(config) {\n" +
        "                super(config);\n" +
        "                this.options = config.options || [];\n" +
        "                this.createDropdownInput();\n" +
        "            }\n" +
        "            \n" +
        "            createDropdownInput(){\n" +
        "                const wrapper = document.createElement(\"div\");\n" +
        "                const label = document.createElement(\"label\");\n" +
        "                label.textContent = this.title;\n" +
        "\n" +
        "                const select = document.createElement(\"select\");\n" +
        "                select.id = \"field_\" + this.instanceId;\n" +
        "\n" +
        "                this.options.forEach(optionText => {\n" +
        "                    const option = document.createElement(\"option\");\n" +
        "                    option.value = optionText;\n" +
        "                    option.textContent = optionText;\n" +
        "                    select.appendChild(option);\n" +
        "                });\n" +
        "\n" +
        "                wrapper.appendChild(label);\n" +
        "                wrapper.appendChild(select);\n" +
        "                this.bodyEl.appendChild(wrapper);\n" +
        "            }\n" +
        "        }\n" +
        "        \n" +
        "        class DateFormField extends BaseFormField{\n" +
        "            constructor(config) {\n" +
        "                super(config);\n" +
        "                this.createDateInput();\n" +
        "            }\n" +
        "\n" +
        "            createDateInput() {\n" +
        "                const wrapper = document.createElement(\"div\");\n" +
        "                const label = document.createElement(\"label\");\n" +
        "                label.textContent = this.title;\n" +
        "\n" +
        "                const input = document.createElement(\"input\");\n" +
        "                input.type = \"date\";\n" +
        "                input.id = \"field_\" + this.instanceId;\n" +
        "\n" +
        "                wrapper.appendChild(label);\n" +
        "                wrapper.appendChild(input);\n" +
        "                this.bodyEl.appendChild(wrapper);\n" +
        "            }\n" +
        "        }\n" +
        "        \n" +
        "        class InfoFormField extends BaseFormField{\n" +
        "            constructor(config) {\n" +
        "                super(config);\n" +
        "                this.value = config.value || \"\";\n" +
        "                this.createInfoText();\n" +
        "            }\n" +
        "            \n" +
        "            createInfoText(){\n" +
        "                const wrapper = document.createElement(\"div\");\n" +
        "                const text = document.createElement(\"p\");\n" +
        "                text.textContent = this.value;\n" +
        "                text.style.margin = \"0\";\n" +
        "                text.style.fontSize = \"14px\";\n" +
        "\n" +
        "                wrapper.appendChild(text);\n" +
        "                this.bodyEl.appendChild(wrapper);\n" +
        "            }\n" +
        "        }\n" +
        "        \n" +
        "        class PictureFormField extends BaseFormField{\n" +
        "            constructor(config) {\n" +
        "                super(config);\n" +
        "                this.value = config.value || \"\";\n" +
        "                this.createPicture();\n" +
        "            }\n" +
        "            \n" +
        "            createPicture(){\n" +
        "                const wrapper = document.createElement(\"div\");\n" +
        "                if (this.value) {\n" +
        "                    const img = document.createElement(\"img\");\n" +
        "                    img.src = this.value;\n" +
        "                    img.alt = this.title;\n" +
        "                    wrapper.appendChild(img);\n" +
        "                }\n" +
        "                this.bodyEl.appendChild(wrapper);\n" +
        "            }\n" +
        "        }\n" +
        "        \n" +
        "        class FileFormField extends BaseFormField{\n" +
        "            constructor(config) {\n" +
        "                super(config);\n" +
        "                this.createFileInput();\n" +
        "            }\n" +
        "\n" +
        "            createFileInput() {\n" +
        "                const wrapper = document.createElement(\"div\");\n" +
        "                const label = document.createElement(\"label\");\n" +
        "                label.textContent = this.title;\n" +
        "\n" +
        "                const input = document.createElement(\"input\");\n" +
        "                input.type = \"file\";\n" +
        "                input.id = \"field_\" + this.instanceId;\n" +
        "\n" +
        "                wrapper.appendChild(label);\n" +
        "                wrapper.appendChild(input);\n" +
        "                this.bodyEl.appendChild(wrapper);\n" +
        "            }\n" +
        "        }\n" +
        "        \n" +
        "        class NumberFormField extends BaseFormField{\n" +
        "            constructor(config) {\n" +
        "                super(config);\n" +
        "                this.createNumberInput();\n" +
        "            }\n" +
        "\n" +
        "            createNumberInput() {\n" +
        "                const wrapper = document.createElement(\"div\");\n" +
        "                const label = document.createElement(\"label\");\n" +
        "                label.textContent = this.title;\n" +
        "\n" +
        "                const input = document.createElement(\"input\");\n" +
        "                input.type = \"number\";\n" +
        "                input.id = \"field_\" + this.instanceId;\n" +
        "\n" +
        "                wrapper.appendChild(label);\n" +
        "                wrapper.appendChild(input);\n" +
        "                this.bodyEl.appendChild(wrapper);\n" +
        "            }\n" +
        "        }\n" +
        "        \n" +
        "        class RadioMultipleChoiceFormField extends BaseFormField{\n" +
        "            constructor(config){\n" +
        "                super(config);\n" +
        "                this.options = config.options || [];\n" +
        "                this.allowMultiple = config.allowMultiple || false;\n" +
        "                this.createOptions();\n" +
        "            }\n" +
        "            \n" +
        "            createOptions(){\n" +
        "                const wrapper = document.createElement(\"div\");\n" +
        "                const label = document.createElement(\"label\");\n" +
        "                label.textContent = this.title;\n" +
        "                wrapper.appendChild(label);\n" +
        "\n" +
        "                this.options.forEach((optionText, index) => {\n" +
        "                    const optionWrapper = document.createElement(\"div\");\n" +
        "                    optionWrapper.style.marginTop = \"8px\";\n" +
        "\n" +
        "                    const input = document.createElement(\"input\");\n" +
        "                    input.type = this.allowMultiple ? \"checkbox\" : \"radio\";\n" +
        "                    input.id = \"field_\" + this.instanceId + \"_\" + index;\n" +
        "                    input.name = \"field_\" + this.instanceId;\n" +
        "                    input.value = optionText;\n" +
        "\n" +
        "                    const optionLabel = document.createElement(\"label\");\n" +
        "                    optionLabel.htmlFor = input.id;\n" +
        "                    optionLabel.textContent = optionText;\n" +
        "                    optionLabel.style.marginLeft = \"8px\";\n" +
        "                    optionLabel.style.fontWeight = \"normal\";\n" +
        "\n" +
        "                    optionWrapper.appendChild(input);\n" +
        "                    optionWrapper.appendChild(optionLabel);\n" +
        "                    wrapper.appendChild(optionWrapper);\n" +
        "                });\n" +
        "\n" +
        "                this.bodyEl.appendChild(wrapper);\n" +
        "            }\n" +
        "        }\n" +
        "        \n" +
        "        // Render nach DOM-Load\n" +
        "        if (document.readyState === 'loading') {\n" +
        "            document.addEventListener('DOMContentLoaded', () => renderForm(specs));\n" +
        "        } else {\n" +
        "            renderForm(specs);\n" +
        "        }\n" +
        "    <"+"/script>\n" +
        "</body>\n" +
        "</html>";
    }
</script>
</body>
</html>
