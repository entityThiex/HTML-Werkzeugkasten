<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Oberklasse-Feld (Basisversion)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }

    #form-builder {
      position: relative;
      width: 100%;
      height: 100%;
      background: #f0f0f0;
    }

    .field {
      position: absolute;
      top: 50px;
      left: 50px;
      width: 360px;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    .field-header {
      cursor: move;
      background: #007bff;
      color: #fff;
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 6px 6px 0 0;
    }

    .field-title {
      font-size: 14px;
      font-weight: bold;
      position: relative;
    }

    /* Tooltip */
    .field-title[data-info]:hover::after {
      content: attr(data-info);
      position: absolute;
      left: 0;
      top: 130%;
      background: #333;
      color: #fff;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 10;
    }

    .field-required {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }

    .field-body {
      padding: 8px 10px 10px;
    }

    .field-required-indicator {
      color: #ffeb3b;
      margin-left: 4px;
      font-size: 14px;
    }

    /* Konfiguration (Titel & Zusatzinfo) */
    .field-config {
      margin-bottom: 8px;
      padding: 6px;
      background: #f5f5f5;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 12px;
    }

    .field-config label {
      display: block;
      margin-bottom: 3px;
      font-weight: bold;
    }

    .field-config input[type="text"],
    .field-config textarea {
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
      padding: 4px;
      border-radius: 3px;
      border: 1px solid #ccc;
      margin-bottom: 6px;
      resize: vertical;
    }
  </style>
</head>
<body>
  <div id="form-builder"></div>

  <script>
    // ===== Oberklasse: BaseField =====
    class BaseField {
      static instanceCounter = 0;  // Statische Variable für alle Instanzen

      constructor(options) {
        BaseField.instanceCounter++;  // Erhöhe Zähler bei jeder neuen Instanz
        this.instanceId = BaseField.instanceCounter;  // Speichere aktuelle Nummer in der Instanz
        
        this.type = options.type || "base";         
        this.title = options.title || "";       // intern gespeichert
        this.infoText = options.infoText || "";     
        this.required = !!options.required;
        this.x = options.x || 50;
        this.y = options.y || 50;

        this.createDOM();
        this.initDrag();
        this.initRequiredCheckbox();
        this.initConfigUI(); // Titel + Zusatzinfo editierbar
      }

      createDOM() {
        const container = document.getElementById("form-builder");

        this.el = document.createElement("div");
        this.el.className = "field";
        this.el.style.left = this.x + "px";
        this.el.style.top = this.y + "px";

        // Header
        const header = document.createElement("div");
        header.className = "field-header";

        const titleSpan = document.createElement("span");
        titleSpan.className = "field-title";
        titleSpan.textContent = "Feld"; // Anzeige bleibt immer gleich
        if (this.infoText) {
          titleSpan.setAttribute("data-info", this.infoText);
        }
        this.titleEl = titleSpan;

        const rightHeader = document.createElement("div");
        rightHeader.className = "field-required";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = this.required;
        this.requiredCheckbox = cb;

        const cbLabel = document.createElement("span");
        cbLabel.textContent = "Pflicht";

        const reqIndicator = document.createElement("span");
        reqIndicator.className = "field-required-indicator";
        reqIndicator.textContent = this.required ? "*" : "";
        this.requiredIndicator = reqIndicator;

        rightHeader.appendChild(cb);
        rightHeader.appendChild(cbLabel);
        rightHeader.appendChild(reqIndicator);

        header.appendChild(titleSpan);
        header.appendChild(rightHeader);

        const body = document.createElement("div");
        body.className = "field-body";
        this.bodyEl = body;

        this.el.appendChild(header);
        this.el.appendChild(body);
        container.appendChild(this.el);
      }

      initRequiredCheckbox() {
        this.requiredCheckbox.addEventListener("change", () => {
          this.required = this.requiredCheckbox.checked;
          this.requiredIndicator.textContent = this.required ? "*" : "";
        });
      }

      // Titel + Zusatzinfo editierbar (intern gespeichert)
      initConfigUI() {
        const config = document.createElement("div");
        config.className = "field-config";

        // Titel (intern gespeichert, nicht sichtbar im Header)
        const titleLabel = document.createElement("label");
        titleLabel.textContent = "Titel";

        const titleInput = document.createElement("input");
        titleInput.type = "text";
        titleInput.value = this.title;

        titleInput.addEventListener("input", () => {
          this.title = titleInput.value;
        });

        // Zusatzinfo (Tooltip)
        const infoLabel = document.createElement("label");
        infoLabel.textContent = "Zusatzinfo";

        const infoInput = document.createElement("textarea");
        infoInput.rows = 2;
        infoInput.value = this.infoText;

        infoInput.addEventListener("input", () => {
          this.infoText = infoInput.value;
          if (this.infoText.trim()) {
            this.titleEl.setAttribute("data-info", this.infoText);
          } else {
            this.titleEl.removeAttribute("data-info");
          }
        });

        config.appendChild(titleLabel);
        config.appendChild(titleInput);
        config.appendChild(infoLabel);
        config.appendChild(infoInput);

        this.bodyEl.appendChild(config);
      }

      initDrag() {
        const header = this.el.querySelector(".field-header");
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;

        header.addEventListener("mousedown", (e) => {
          isDragging = true;
          const rect = this.el.getBoundingClientRect();
          offsetX = e.clientX - rect.left;
          offsetY = e.clientY - rect.top;

          document.addEventListener("mousemove", onMouseMove);
          document.addEventListener("mouseup", onMouseUp);
        });

        const onMouseMove = (e) => {
          if (!isDragging) return;
          const parentRect = this.el.parentElement.getBoundingClientRect();
          let x = e.clientX - parentRect.left - offsetX;
          let y = e.clientY - parentRect.top - offsetY;

          // Begrenzung im Container
          x = Math.max(0, Math.min(parentRect.width - this.el.offsetWidth, x));
          y = Math.max(0, Math.min(parentRect.height - this.el.offsetHeight, y));

          this.el.style.left = x + "px";
          this.el.style.top = y + "px";
        };

        const onMouseUp = () => {
          isDragging = false;
          document.removeEventListener("mousemove", onMouseMove);
          document.removeEventListener("mouseup", onMouseUp);
        };
      }

      // Für spätere HTML-Erzeugung vorbereiten
      toConfigObject() {
        const rect = this.el.getBoundingClientRect();
        const parentRect = this.el.parentElement.getBoundingClientRect();
        return {
          type: this.type,
          title: this.title,         // gespeicherter individueller Titel
          infoText: this.infoText,   // gespeicherter Tooltip
          required: this.required,
          x: rect.left - parentRect.left,
          y: rect.top - parentRect.top
        };
      }
    }
    // Hinweis: toConfigObject() liefert später alle wichtigen Daten für HTML-Generierung

    class Textfield extends BaseField {
      constructor(options) {
        super({ ...options, type: "text" });
        this.createTextInput();
        this.titleEl.textContent = "Textfeld";
      }

      createTextInput() {
        const wrapper = document.createElement("div");
        
        // Label hinzufügen
        const label = document.createElement("label");
        label.textContent = "Text";
        label.style.display = "block";
        label.style.marginBottom = "4px";
        label.style.fontSize = "12px";
        
        // Input erstellen
        const input = document.createElement("input");
        input.type = "text";
        input.style.width = "100%";
        input.style.boxSizing = "border-box";
        
        // Alles zusammenfügen
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        this.bodyEl.appendChild(wrapper);
      }
    }

    class DropDownfield extends BaseField {
      constructor(options) {
        super({ ...options, type: "dropdown" });
        this.options = [];
        this.createSelectInput();
        this.titleEl.textContent = "Dropdown-Feld";
      }

      createSelectInput() {
        const wrapper = document.createElement("div");
        
        // Label für das Dropdown
        const label = document.createElement("label");
        label.textContent = "Optionen";
        label.style.display = "block";
        label.style.marginBottom = "4px";
        label.style.fontSize = "12px";

        // Container für Input und Button
        const inputContainer = document.createElement("div");
        inputContainer.style.display = "flex";
        inputContainer.style.marginBottom = "10px";
        inputContainer.style.gap = "5px";

        // Textfeld für neue Optionen
        const input = document.createElement("input");
        input.type = "text";
        input.style.flex = "1";
        input.placeholder = "Neue Option eingeben";

        // Hinzufügen Button
        const addButton = document.createElement("button");
        addButton.textContent = "Hinzufügen";
        addButton.style.padding = "4px 8px";

        // Styling für drag & drop hinzufügen
        const optionsContainer = document.createElement("div");
        optionsContainer.style.maxHeight = "150px";
        optionsContainer.style.overflowY = "auto";
        optionsContainer.style.padding = "4px";
        
        // Event Listener für das Hinzufügen
        addButton.addEventListener("click", () => {
            if (input.value.trim()) {
                this.addOption(input.value.trim());
                input.value = "";
            }
        });

        // Enter-Taste auch zum Hinzufügen nutzen
        input.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && input.value.trim()) {
                this.addOption(input.value.trim());
                input.value = "";
            }
        });

        inputContainer.appendChild(input);
        inputContainer.appendChild(addButton);
        
        wrapper.appendChild(label);
        wrapper.appendChild(inputContainer);
        wrapper.appendChild(optionsContainer);
        
        this.optionsContainer = optionsContainer;
        this.bodyEl.appendChild(wrapper);
      }

      addOption(text) {
        const optionDiv = document.createElement("div");
        optionDiv.style.display = "flex";
        optionDiv.style.justifyContent = "space-between";
        optionDiv.style.alignItems = "center";
        optionDiv.style.padding = "4px";
        optionDiv.style.marginBottom = "4px";
        optionDiv.style.backgroundColor = "#f5f5f5";
        optionDiv.style.borderRadius = "4px";
        optionDiv.style.cursor = "move"; // Cursor für Drag & Drop
        
        // Drag & Drop Attribute
        optionDiv.draggable = true;
        
        // Drag & Drop Event Listener
        optionDiv.addEventListener('dragstart', (e) => {
            e.target.classList.add('dragging');
            e.target.style.opacity = '0.5';
        });

        optionDiv.addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
            e.target.style.opacity = '1';
            this.updateOptions();
        });

        optionDiv.addEventListener('dragover', (e) => {
            e.preventDefault();
            const draggingItem = this.optionsContainer.querySelector('.dragging');
            const siblings = [...this.optionsContainer.querySelectorAll('div:not(.dragging)')];
            const nextSibling = siblings.find(sibling => {
                const box = sibling.getBoundingClientRect();
                const offset = e.clientY - box.top - box.height / 2;
                return offset < 0;
            });
            
            if (nextSibling) {
                this.optionsContainer.insertBefore(draggingItem, nextSibling);
            } else {
                this.optionsContainer.appendChild(draggingItem);
            }
        });

        // Highlight beim Draggen
        optionDiv.addEventListener('dragenter', (e) => {
            e.preventDefault();
            optionDiv.style.borderTop = '2px solid #007bff';
        });

        optionDiv.addEventListener('dragleave', (e) => {
            e.preventDefault();
            optionDiv.style.borderTop = 'none';
        });

        optionDiv.addEventListener('drop', (e) => {
            e.preventDefault();
            optionDiv.style.borderTop = 'none';
        });

        const optionText = document.createElement("span");
        optionText.textContent = text;
        optionText.style.fontSize = "12px";
        optionText.style.pointerEvents = "none"; // Verhindert Störungen beim Drag & Drop

        const deleteButton = document.createElement("button");
        deleteButton.textContent = "×";
        deleteButton.style.padding = "2px 6px";
        deleteButton.style.backgroundColor = "#ff4444";
        deleteButton.style.color = "white";
        deleteButton.style.border = "none";
        deleteButton.style.borderRadius = "3px";
        deleteButton.style.cursor = "pointer";

        deleteButton.addEventListener("click", () => {
            optionDiv.remove();
            this.updateOptions();
        });

        optionDiv.appendChild(optionText);
        optionDiv.appendChild(deleteButton);
        this.optionsContainer.appendChild(optionDiv);
        
        this.updateOptions();
      }

      updateOptions() {
        // Aktualisiert das Array mit allen Optionen
        this.options = Array.from(this.optionsContainer.querySelectorAll("span"))
            .map(span => span.textContent);
      }

      toConfigObject() {
        const baseConfig = super.toConfigObject();
        return {
            ...baseConfig,
            options: this.options
        };
      }
    }

    // Beispiel: Erstelle ein Textfeld
    /*
      const textField = new Textfield({
        title: "",
        infoText: "",
        required: true,
        x: 100,
        y: 100
      });
    */

    class DateField extends BaseField {

        constructor(options){
            super({...options, type: "date"});
            this.createDateInput()
        }

        createDateInput() {
            const wrapper = document.createElement("div");

            // Label
            const label = document.createElement("label");
            label.textContent = "Datum Feld";
            label.style.display = "block";
            label.style.marginBottom = "4px";
            label.style.fontSize = "12px";

            // Input
            const input = document.createElement("input");
            input.type = "date";
            input.style.width = "100%";
            input.style.boxSizing = "border-box";

            // Combine the ELEMENTS!!!!
            wrapper.appendChild(label);
            wrapper.appendChild(input);
            this.bodyEl.appendChild(wrapper);
        }
    }

    /*
    const dateField = new DateField({
        title: "",
        infoText: "",
        required: true,
        x: 100,
        y: 100
    });

     */
    
    // Darf später nicht bearbeitbar sein, ansonsten ists gleich wie das Textfeld
    class InfoField extends BaseField {

        constructor(options){
            super({...options, type: "info", required: false});
            this.createInfoInput()
        }

        createInfoInput() {
            const wrapper = document.createElement("div");

            // Label
            const label = document.createElement("label");
            label.textContent = "Info Feld";
            label.style.display = "block";
            label.style.marginBottom = "4px";
            label.style.fontSize = "12px";

            // Input
            const input = document.createElement("textarea");
            input.rows = 2;
            input.style.width = "100%";
            input.style.boxSizing = "border-box";

            // Combine the ELEMENTS!!!!
            wrapper.appendChild(label);
            wrapper.appendChild(input);
            this.bodyEl.appendChild(wrapper);
        }
    }

    /*
    const infoField = new InfoField({
        title: "",
        infoText: "",
        required: true,
        x: 100,
        y: 100
    });

     */

    class PictureField extends BaseField {

        constructor(options){
            super({...options, type: "picture"});
            this.createPictureInput()
        }

        createPictureInput() {
            const wrapper = document.createElement("div");

            // Label
            const label = document.createElement("label");
            label.textContent = "Bild Feld";
            label.style.display = "block";
            label.style.marginBottom = "4px";
            label.style.fontSize = "12px";

            // Input
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*";
            input.style.width = "100%";
            input.style.boxSizing = "border-box";

            // Combine the ELEMENTS!!!!
            wrapper.appendChild(label);
            wrapper.appendChild(input);
            this.bodyEl.appendChild(wrapper);
        }
    }

    /*
    const pictureField = new PictureField({
        title: "",
        infoText: "",
        required: true,
        x: 100,
        y: 100
    });

     */

    class NumberField extends BaseField {

        constructor(options){
            super({...options, type: "number"});
            this.createNumberInput()
        }

        createNumberInput() {
            const wrapper = document.createElement("div");

            // Label
            const label = document.createElement("label");
            label.textContent = "Nummer Feld";
            label.style.display = "block";
            label.style.marginBottom = "4px";
            label.style.fontSize = "12px";

            // Input
            const input = document.createElement("input");
            input.type = "number";
            input.style.width = "100%";
            input.style.boxSizing = "border-box";

            // Combine the ELEMENTS!!!!
            wrapper.appendChild(label);
            wrapper.appendChild(input);
            this.bodyEl.appendChild(wrapper);
        }
    }
    /*
    const numberField = new NumberField({
        infoText: "",
        required: true,
        x: 100,
        y: 100
    });

     */
   
  </script>
</body>
</html>
